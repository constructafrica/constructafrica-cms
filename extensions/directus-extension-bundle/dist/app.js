import{useApi as e}from"@directus/extensions-sdk";import{ref as a,reactive as n,onMounted as o,onBeforeUnmount as t,watch as l,resolveComponent as r,openBlock as d,createElementBlock as i,Fragment as c,renderList as s,createCommentVNode as p,createVNode as m,createElementVNode as u,withCtx as y,createBlock as v,toDisplayString as h,createTextVNode as f}from"vue";import{useI18n as g}from"vue-i18n";var b=[],w=[];!function(e,a){if(e&&"undefined"!=typeof document){var n,o=!0===a.prepend?"prepend":"append",t=!0===a.singleTag,l="string"==typeof a.container?document.querySelector(a.container):document.getElementsByTagName("head")[0];if(t){var r=b.indexOf(l);-1===r&&(r=b.push(l)-1,w[r]={}),n=w[r]&&w[r][o]?w[r][o]:w[r][o]=d()}else n=d();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function d(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),a.attributes)for(var n=Object.keys(a.attributes),t=0;t<n.length;t++)e.setAttribute(n[t],a.attributes[n[t]]);var r="prepend"===o?"afterbegin":"beforeend";return l.insertAdjacentElement(r,e),e}}("\n.project-companies-selector[data-v-9354d9c3] {\n  padding: 12px;\n  background-color: var(--theme--background-subdued);\n  border-radius: var(--theme--border-radius);\n}\n.company-row[data-v-9354d9c3] {\n  display: grid;\n  grid-template-columns: 200px 1fr 40px;\n  gap: 12px;\n  align-items: start;\n  margin-bottom: 12px;\n  padding: 12px;\n  background-color: var(--theme--background);\n  border-radius: var(--theme--border-radius);\n  border: 2px solid var(--theme--border-color-subdued);\n}\n.role-select[data-v-9354d9c3] {\n  width: 100%;\n}\n.company-select-wrapper[data-v-9354d9c3] {\n  position: relative;\n  width: 100%;\n}\n.company-dropdown[data-v-9354d9c3] {\n  position: absolute;\n  top: 100%;\n  left: 0;\n  right: 0;\n  margin-top: 4px;\n  max-height: 300px;\n  overflow-y: auto;\n  background-color: var(--theme--background);\n  border: 2px solid var(--theme--border-color-subdued);\n  border-radius: var(--theme--border-radius);\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n  z-index: 100;\n}\n.company-option[data-v-9354d9c3] {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 12px;\n  cursor: pointer;\n  transition: background-color 0.2s;\n}\n.company-option[data-v-9354d9c3]:hover {\n  background-color: var(--theme--background-subdued);\n}\n.company-option.create-new[data-v-9354d9c3] {\n  border-top: 2px solid var(--theme--border-color-subdued);\n  color: var(--theme--primary);\n  font-weight: 500;\n}\n.company-info[data-v-9354d9c3] {\n  flex: 1;\n  min-width: 0;\n}\n.company-name[data-v-9354d9c3] {\n  font-size: 14px;\n  font-weight: 500;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.company-email[data-v-9354d9c3] {\n  font-size: 12px;\n  color: var(--theme--foreground-subdued);\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.no-results[data-v-9354d9c3] {\n  padding: 12px;\n  text-align: center;\n  color: var(--theme--foreground-subdued);\n  font-size: 14px;\n}\n.remove-btn[data-v-9354d9c3] {\n  color: var(--theme--danger);\n  cursor: pointer;\n  transition: transform 0.2s;\n  margin-top: 8px;\n}\n.remove-btn[data-v-9354d9c3]:hover {\n  transform: scale(1.1);\n}\n.grid[data-v-9354d9c3] {\n  display: grid;\n  gap: 20px;\n}\n.field[data-v-9354d9c3] {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n.field.full[data-v-9354d9c3] {\n  grid-column: 1 / -1;\n}\n.field.half[data-v-9354d9c3] {\n  grid-column: span 1;\n}\n.type-label[data-v-9354d9c3] {\n  font-weight: 600;\n  font-size: 14px;\n  color: var(--theme--foreground);\n}\n@media (max-width: 768px) {\n.company-row[data-v-9354d9c3] {\n    grid-template-columns: 1fr;\n}\n.remove-btn[data-v-9354d9c3] {\n    justify-self: end;\n    margin-top: 0;\n}\n.field.half[data-v-9354d9c3] {\n    grid-column: 1 / -1;\n}\n}\n",{});var _=(e,a)=>{const n=e.__vccOpts||e;for(const[e,o]of a)n[e]=o;return n};const x={props:{value:{type:Array,default:()=>[]},collection:{type:String,default:null},primaryKey:{type:[String,Number],default:null}},emits:["input"],setup(r,{emit:d}){const i=e(),{t:c}=g(),s=a([]),p=a([]),m=n({}),u=n({}),y=n({}),v=n({}),h=a(!1),f=a(!1),b=a(!1),w=a(!1),_=a(null),x=a(null),C={},k=a({name:"",email:"",phone:""}),V=async(e,a)=>{if(!a||a.length<2)u[e]=[];else{_.value=e,w.value=!0;try{const n=a.trim().split(/\s+/).filter(e=>e.length>0).map(e=>({name:{_icontains:e}})),o=await i.get("/items/companies",{params:{fields:["id","name","email"],limit:50,filter:{_or:n},sort:["name"]}});u[e]=o.data.data.map(e=>({text:e.name,value:e.id,company:e}))}catch(a){console.error("Error searching companies:",a),u[e]=[]}finally{w.value=!1,_.value=null}}},j=async()=>{if(!r.primaryKey||"+"===r.primaryKey)return console.log("New item or invalid primaryKey, adding empty row"),void(0===s.value.length&&S());try{console.log("Loading existing data for project:",r.primaryKey);const e=await i.get("/items/project_companies",{params:{filter:{project_id:{_eq:r.primaryKey}},fields:["id","role_id","company_id.id","company_id.name"],limit:-1}});console.log("Loaded project_companies:",e.data.data),e.data.data.length>0?(s.value=[],e.data.data.forEach((e,a)=>{const n="object"==typeof e.company_id?e.company_id.id:e.company_id,o="object"==typeof e.company_id?e.company_id.name:"";s.value.push({id:e.id,role_id:e.role_id,company_id:n}),o&&(m[a]=o,v[a]=o),u[a]=[],y[a]=!1})):S()}catch(e){console.error("Error loading existing data:",e),0===s.value.length&&S()}};o(async()=>{console.log("Component mounted, primaryKey:",r.primaryKey),await(async()=>{b.value=!0;try{const e=await i.get("/items/project_company_roles",{params:{fields:["id","name","slug"],limit:-1,sort:["name"]}});p.value=e.data.data.map(e=>({text:e.name,value:e.id}))}catch(e){console.error("Error loading roles:",e)}finally{b.value=!1}})(),await j(),console.log("After loadExistingData:",{internalValue:s.value,searchQueries:{...m}}),document.addEventListener("click",E)}),t(()=>{document.removeEventListener("click",E),Object.values(C).forEach(e=>clearTimeout(e))});const E=e=>{e.target.closest(".company-select-wrapper")||Object.keys(y).forEach(e=>{y[e]=!1})};l(()=>r.value,e=>{e&&Array.isArray(e)&&e.length>0&&(s.value=e.map(e=>({id:e.id||null,role_id:e.role_id||null,company_id:"object"==typeof e.company_id?e.company_id?.id:e.company_id})))},{deep:!0}),l(()=>r.primaryKey,(e,a)=>{console.log("PrimaryKey changed from",a,"to",e),e!==a&&e&&"+"!==e&&(s.value=[],Object.keys(m).forEach(e=>delete m[e]),Object.keys(u).forEach(e=>delete u[e]),Object.keys(y).forEach(e=>delete y[e]),Object.keys(v).forEach(e=>delete v[e]),j())});const S=()=>{const e=s.value.length;s.value.push({id:null,role_id:null,company_id:null}),m[e]="",u[e]=[],y[e]=!1,D()},D=()=>{const e=s.value.filter(e=>e.role_id&&e.company_id).map(e=>({id:e.id,role_id:e.role_id,company_id:e.company_id}));d("input",e.length>0?e:[])};return{t:c,internalValue:s,roleOptions:p,searchQueries:m,filteredCompanies:u,showDropdown:y,selectedCompanyNames:v,showCreateDialog:h,creating:f,loadingRoles:b,loadingCompanies:w,activeSearchIndex:_,newCompany:k,addItem:S,removeItem:e=>{s.value.splice(e,1),delete m[e],delete u[e],delete y[e],delete v[e],D()},handleSearchInput:(e,a)=>{m[e]=a,y[e]=!0,C[e]&&clearTimeout(C[e]),C[e]=setTimeout(()=>{V(e,a)},300)},handleSearchFocus:e=>{y[e]=!0,m[e]&&m[e].length>=2&&V(e,m[e])},selectCompany:(e,a)=>{s.value[e].company_id=a.value,m[e]=a.text,v[e]=a.text,y[e]=!1,D()},companyExistsInResults:e=>{const a=m[e]?.toLowerCase();return u[e]?.some(e=>e.text.toLowerCase()===a)},handleCreateNew:e=>{x.value=e,k.value.name=m[e],y[e]=!1,h.value=!0},createCompany:async()=>{if(k.value.name){f.value=!0;try{const e=(await i.post("/items/companies",k.value)).data.data;if(null!==x.value){const a=x.value;s.value[a].company_id=e.id,m[a]=e.name,v[a]=e.name,D()}h.value=!1,k.value={name:"",email:"",phone:""},x.value=null}catch(e){console.error("Error creating company:",e),alert("Failed to create company. Please try again.")}finally{f.value=!1}}},updateValue:D}}},C={class:"project-companies-selector"},k={class:"company-select-wrapper"},V={key:0,class:"company-dropdown"},j=["onClick"],E={class:"company-info"},S={class:"company-name"},D={key:0,class:"company-email"},I=["onClick"],O={class:"company-info"},K={class:"company-name"},N={key:1,class:"no-results"},A={class:"grid"},T={class:"field full"},Q={class:"type-label"},U={class:"field half"},R={class:"type-label"},L={class:"field half"},z={class:"type-label"};const F=[{id:"project-companies-selector",name:"Project Companies Selector",description:"Select companies with roles in a user-friendly interface",icon:"business",component:_(x,[["render",function(e,a,n,o,t,l){const g=r("v-select"),b=r("v-icon"),w=r("v-input"),_=r("v-button"),x=r("v-card-title"),F=r("v-card-text"),B=r("v-card-actions"),P=r("v-card"),q=r("v-dialog");return d(),i("div",C,[(d(!0),i(c,null,s(o.internalValue,(e,a)=>(d(),i("div",{key:e.id||`new-${a}`,class:"company-row"},[p(" Role Dropdown "),m(g,{modelValue:e.role_id,"onUpdate:modelValue":[a=>e.role_id=a,o.updateValue],items:o.roleOptions,"item-title":"text","item-value":"value",placeholder:o.t("select_role"),loading:o.loadingRoles,class:"role-select"},null,8,["modelValue","onUpdate:modelValue","items","placeholder","loading"]),p(" Company Search Input with Dropdown "),u("div",k,[m(w,{"model-value":o.searchQueries[a]||"",placeholder:o.t("search_or_create_company"),"onUpdate:modelValue":e=>o.handleSearchInput(a,e),onFocus:e=>o.handleSearchFocus(a)},{prepend:y(()=>[m(b,{name:"business",small:""})]),append:y(()=>[o.loadingCompanies&&o.activeSearchIndex===a?(d(),v(b,{key:0,name:"refresh",small:"",spin:""})):p("v-if",!0)]),_:2},1032,["model-value","placeholder","onUpdate:modelValue","onFocus"]),p(" Dropdown Results "),o.showDropdown[a]&&(o.filteredCompanies[a]?.length>0||o.searchQueries[a]?.length>0)?(d(),i("div",V,[(d(!0),i(c,null,s(o.filteredCompanies[a],e=>(d(),i("div",{key:e.value,class:"company-option",onClick:n=>o.selectCompany(a,e)},[m(b,{name:"business",small:""}),u("div",E,[u("div",S,h(e.text),1),e.company?.email?(d(),i("div",D,h(e.company.email),1)):p("v-if",!0)])],8,j))),128)),p(" Create New Option "),o.searchQueries[a]&&o.searchQueries[a].length>2&&!o.companyExistsInResults(a)?(d(),i("div",{key:0,class:"company-option create-new",onClick:e=>o.handleCreateNew(a)},[m(b,{name:"add_circle",small:""}),u("div",O,[u("div",K,'Create "'+h(o.searchQueries[a])+'"',1)])],8,I)):p("v-if",!0),!o.loadingCompanies&&0===o.filteredCompanies[a]?.length&&o.searchQueries[a]?.length>0?(d(),i("div",N," No companies found. Type to create new. ")):p("v-if",!0)])):p("v-if",!0)]),p(" Remove Button "),m(b,{name:"close",clickable:"",class:"remove-btn",onClick:e=>o.removeItem(a)},null,8,["onClick"])]))),128)),p(" Add New Button "),m(_,{secondary:"",small:"",onClick:o.addItem},{default:y(()=>[m(b,{name:"add",small:""}),f(" "+h(o.t("add_company")),1)]),_:1},8,["onClick"]),p(" Create Company Dialog "),m(q,{modelValue:o.showCreateDialog,"onUpdate:modelValue":a[4]||(a[4]=e=>o.showCreateDialog=e),onEsc:a[5]||(a[5]=e=>o.showCreateDialog=!1)},{default:y(()=>[m(P,null,{default:y(()=>[m(x,null,{default:y(()=>[f(h(o.t("create_new_company")),1)]),_:1}),m(F,null,{default:y(()=>[u("div",A,[u("div",T,[u("div",Q,h(o.t("company_name")),1),m(w,{modelValue:o.newCompany.name,"onUpdate:modelValue":a[0]||(a[0]=e=>o.newCompany.name=e),placeholder:o.t("enter_company_name"),autofocus:""},null,8,["modelValue","placeholder"])]),u("div",U,[u("div",R,h(o.t("email")),1),m(w,{modelValue:o.newCompany.email,"onUpdate:modelValue":a[1]||(a[1]=e=>o.newCompany.email=e),type:"email",placeholder:o.t("enter_email")},null,8,["modelValue","placeholder"])]),u("div",L,[u("div",z,h(o.t("phone")),1),m(w,{modelValue:o.newCompany.phone,"onUpdate:modelValue":a[2]||(a[2]=e=>o.newCompany.phone=e),placeholder:o.t("enter_phone")},null,8,["modelValue","placeholder"])])])]),_:1}),m(B,null,{default:y(()=>[m(_,{secondary:"",onClick:a[3]||(a[3]=e=>o.showCreateDialog=!1)},{default:y(()=>[f(h(o.t("cancel")),1)]),_:1}),m(_,{loading:o.creating,disabled:!o.newCompany.name,onClick:o.createCompany},{default:y(()=>[f(h(o.t("create")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}],["__scopeId","data-v-9354d9c3"],["__file","interface.vue"]]),options:null,types:["alias"],localTypes:["o2m"],group:"relational",relational:!0}],B=[],P=[],q=[],$=[],G=[],H=[];export{B as displays,F as interfaces,P as layouts,q as modules,H as operations,$ as panels,G as themes};
