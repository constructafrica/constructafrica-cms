const e=[{name:"my-hook",config:({filter:e,action:t})=>{e("items.create",()=>{console.log("Creating Item!")}),t("items.create",()=>{console.log("Item created!")})}}],t=[{name:"projects",config:(e,{services:t,exceptions:a})=>{const{ItemsService:i,AssetsService:o}=t;e.get("/",async(e,t,a)=>{try{const a=new i("projects",{schema:e.schema,accountability:e.accountability}),o=e.query.groupBy,s=parseInt(e.query.limit)||25,c=parseInt(e.query.page)||1,n=await a.readByQuery({fields:["id","title","slug","contract_value_usd","summary","description","estimated_project_value_usd","value_range","construction_start_date","location","current_stage","email","countries.countries_id.id","countries.countries_id.name","regions.regions_id.id","regions.regions_id.name","types.types_id.id","sectors.sectors_id.name","sectors.sectors_id.id","types.types_id.name","featured_image.id","featured_image.filename_disk","featured_image.title","featured_image.filesize"],limit:o?-1:s,page:o?1:c,filter:e.query.filter||{},meta:["total_count","filter_count"]}),r=n.data||n,l=n.meta||{},u=r.map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,e.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`);const t=e.countries?[...e.countries]:[],a=e.regions?[...e.regions]:[],i=e.types?[...e.types]:[],s=e.sectors?[...e.sectors]:[];return e.countries&&Array.isArray(e.countries)&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean)),e.regions&&Array.isArray(e.regions)&&(e.regions=e.regions.map(e=>e.regions_id).filter(Boolean)),e.types&&Array.isArray(e.types)&&(e.types=e.types.map(e=>e.types_id).filter(Boolean)),e.sectors&&Array.isArray(e.sectors)&&(e.sectors=e.sectors.map(e=>e.sectors_id).filter(Boolean)),o&&(e._originals={countries:t,regions:a,types:i,sectors:s}),e});if(o){const a=function(e,t){const a=new Map;return e.forEach(e=>{let i=[];switch(t){case"country":i=e._originals.countries.map(e=>({id:e.countries_id?.id,name:e.countries_id?.name||"Unknown Country",data:e.countries_id}));break;case"region":i=e._originals.regions.map(e=>({id:e.regions_id?.id,name:e.regions_id?.name||"Unknown Region",data:e.regions_id}));break;case"type":i=e._originals.types.map(e=>({id:e.types_id?.id,name:e.types_id?.name||"Unknown Type",data:e.types_id}));break;case"company":i=e._originals.companies.map(e=>({id:e.companies_id?.id,name:e.companies_id?.name||"Unknown Company",data:e.companies_id}));break;default:i=[{id:"all",name:"All Projects",data:null}]}0===i.length&&(i=[{id:"unknown",name:`Unknown ${t}`,data:null}]),i.forEach(t=>{a.has(t.id)||a.set(t.id,{id:t.id,name:t.name,data:t.data,projects:[],count:0,totalValue:0});const i=a.get(t.id),o={...e};delete o._originals,i.projects.push(o),i.count++,e.contract_value_usd&&(i.totalValue+=parseFloat(e.contract_value_usd)||0)})}),Array.from(a.values()).sort((e,t)=>e.name.localeCompare(t.name))}(u,o),i=parseInt(e.query.limit)||5,s=parseInt(e.query.page)||1,c=a.length,n=(s-1)*i,r=n+i,l=a.slice(n,r);t.json({data:l,meta:{total_groups:c,groupBy:o,page:s,limit:i,page_count:Math.ceil(c/i)}})}else t.json({data:u,meta:{total_count:l.total_count||l.filter_count||u.length,filter_count:l.filter_count||u.length,page:c,limit:s,page_count:Math.ceil((l.filter_count||u.length)/s)}})}catch(e){a(e)}}),e.get("/:id",async(e,t,a)=>{try{const a=new i("projects",{schema:e.schema,accountability:e.accountability}),o=await a.readOne(e.params.id,{fields:["*","countries.countries_id.*","regions.regions_id.*","types.types_id.*","funding.funding_id.*","client_owner.companies_id.*","developer.companies_id.*","companies.companies_id.*","authority.companies_id.id","authority.companies_id.name","architect.companies_id.id","architect.companies_id.name","design_consultant.companies_id.id","design_consultant.companies_id.name","project_manager.companies_id.id","project_manager.companies_id.name","civil_engineer.companies_id.id","civil_engineer.companies_id.name","structural_engineer.companies_id.id","structural_engineer.companies_id.name","mep_engineer.companies_id.id","mep_engineer.companies_id.name","electrical_engineer.companies_id.id","electrical_engineer.companies_id.name","geotechnical_engineer.companies_id.id","geotechnical_engineer.companies_id.name","cost_consultants.companies_id.id","cost_consultants.companies_id.name","quantity_surveyor.companies_id.id","quantity_surveyor.companies_id.name","landscape_architect.companies_id.id","landscape_architect.companies_id.name","legal_adviser.companies_id.id","legal_adviser.companies_id.name","transaction_advisor.companies_id.id","transaction_advisor.companies_id.name","study_consultant.companies_id.id","study_consultant.companies_id.name","main_contractor.companies_id.id","main_contractor.companies_id.name","main_contract_bidder.companies_id.id","main_contract_bidder.companies_id.name","main_contract_prequalified.companies_id.id","main_contract_prequalified.companies_id.name","mep_subcontractor.companies_id.id","mep_subcontractor.companies_id.name","piling_subcontractor.companies_id.id","piling_subcontractor.companies_id.name","facade_subcontractor.companies_id.id","facade_subcontractor.companies_id.name","lift_subcontractor.companies_id.id","lift_subcontractor.companies_id.name","other_subcontractor.companies_id.id","other_subcontractor.companies_id.name","operator.companies_id.id","operator.companies_id.name","feed.companies_id.id","feed.companies_id.name","featured_image.*"]}),s=(e,t="id")=>e&&Array.isArray(e)?e.map(e=>{const a=e[`${t}_id`]||e;return a&&a.id?{id:a.id,name:a.name||"Unnamed"}:null}).filter(Boolean):[];o.featured_image&&"object"==typeof o.featured_image&&o.featured_image.id&&(o.featured_image.url=`${process.env.PUBLIC_URL}/assets/${o.featured_image.id}`,o.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${o.featured_image.id}?width=400&height=300&fit=cover`),o.countries&&Array.isArray(o.countries)&&(o.countries=o.countries.map(e=>e.countries_id).filter(Boolean)),o.regions&&Array.isArray(o.regions)&&(o.regions=o.regions.map(e=>e.regions_id).filter(Boolean)),o.types&&Array.isArray(o.types)&&(o.types=o.types.map(e=>e.types_id).filter(Boolean)),o.funding&&Array.isArray(o.funding)&&(o.funding=o.funding.map(e=>e.funding_id).filter(Boolean)),o.companies&&Array.isArray(o.companies)&&(o.companies=o.companies.map(e=>e.companies_id).filter(Boolean)),o.client_owner&&Array.isArray(o.client_owner)&&(o.client_owner=o.client_owner.map(e=>e.companies_id).filter(Boolean)),o.developer&&Array.isArray(o.developer)&&(o.developer=o.developer.map(e=>e.companies_id).filter(Boolean)),o.developer=s(o.developer,"companies"),o.authority=s(o.authority,"companies"),o.architect=s(o.architect,"companies"),o.design_consultant=s(o.design_consultant,"companies"),o.project_manager=s(o.project_manager,"companies"),o.civil_engineer=s(o.civil_engineer,"companies"),o.structural_engineer=s(o.structural_engineer,"companies"),o.mep_engineer=s(o.mep_engineer,"companies"),o.electrical_engineer=s(o.electrical_engineer,"companies"),o.geotechnical_engineer=s(o.geotechnical_engineer,"companies"),o.cost_consultants=s(o.cost_consultants,"companies"),o.quantity_surveyor=s(o.quantity_surveyor,"companies"),o.landscape_architect=s(o.landscape_architect,"companies"),o.legal_adviser=s(o.legal_adviser,"companies"),o.transaction_advisor=s(o.transaction_advisor,"companies"),o.study_consultant=s(o.study_consultant,"companies"),o.funding=s(o.funding,"companies"),o.main_contractor=s(o.main_contractor,"companies"),o.main_contract_bidder=s(o.main_contract_bidder,"companies"),o.main_contract_prequalified=s(o.main_contract_prequalified,"companies"),o.mep_subcontractor=s(o.mep_subcontractor,"companies"),o.piling_subcontractor=s(o.piling_subcontractor,"companies"),o.facade_subcontractor=s(o.facade_subcontractor,"companies"),o.lift_subcontractor=s(o.lift_subcontractor,"companies"),o.other_subcontractor=s(o.other_subcontractor,"companies"),o.operator=s(o.operator,"companies"),o.feed=s(o.feed,"companies"),t.json({data:o})}catch(e){a(e)}})}},{name:"favorites",config:(e,{services:t,exceptions:a,database:i})=>{const{ItemsService:o}=t,{ForbiddenException:s,InvalidPayloadException:c,ServiceUnavailableException:n}=a,r=["projects","companies","main_news"];e.post("/toggle",async(e,t)=>{try{const{collection:a,item_id:n}=e.body,{accountability:l}=e;if(!l?.user)throw new s("You must be authenticated to manage favorites");if(!a||!n)throw new c("Collection and item_id are required");if(!r.includes(a))throw new c(`Invalid collection. Must be one of: ${r.join(", ")}`);const u=new o("favorites",{schema:e.schema,accountability:e.accountability}),d=new o(a,{schema:e.schema,accountability:e.accountability});try{await d.readOne(n)}catch(e){return t.status(404).json({success:!1,error:`Item not found in ${a}`})}const m=await u.readByQuery({filter:{_and:[{user_created:{_eq:l.user}},{collection:{_eq:a}},{item_id:{_eq:n}}]},limit:1});if(m.length>0){await u.deleteOne(m[0].id);try{await i(a).where("id",n).decrement("favorites_count",1)}catch(e){console.warn(`Could not decrement favorites_count for ${a}:`,e.message)}return t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"})}{const e=await u.createOne({collection:a,item_id:n});try{await i(a).where("id",n).increment("favorites_count",1)}catch(e){console.warn(`Could not increment favorites_count for ${a}:`,e.message)}return t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(e){return console.error("Toggle favorite error:",e),e instanceof s||e instanceof c?t.status(e.status||400).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:e.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:a}=e.body,{accountability:i}=e;if(!i?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!a||!Array.isArray(a)||0===a.length)return t.status(400).json({success:!1,error:"Items array is required"});if(a.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});for(const e of a){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!r.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const s=new o("favorites",{schema:e.schema,accountability:e.accountability}),c=a.map(e=>({_and:[{user_created:{_eq:i.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),n=await s.readByQuery({filter:{_or:c},limit:-1}),l={};return a.forEach(e=>{const t=`${e.collection}:${e.item_id}`,a=n.find(t=>t.collection===e.collection&&t.item_id===e.item_id);l[t]={collection:e.collection,item_id:e.item_id,favorited:!!a,favorite_id:a?.id||null,date_created:a?.date_created||null}}),t.json({success:!0,authenticated:!0,total:a.length,favorited_count:n.length,results:l})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:a}=e.params,{limit:i=10,period:s="all"}=e.query;if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const c=new o(a,{schema:e.schema,accountability:e.accountability});let n={};if("all"!==s){const e=new Date;let t;switch(s){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(n.date_created={_gte:t.toISOString()})}const l=(await c.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...n},sort:["-favorites_count","-date_created"],limit:parseInt(i)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:a,period:s,total:l.length,popular:l})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:a}=e;if(!a?.user)throw new s("Authentication required");const i=new o("favorites",{schema:e.schema,accountability:e.accountability}),c=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),n=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),r=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"main_news"}},aggregate:{count:"*"}}),l=await i.readByQuery({filter:{user_created:{_eq:a.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(c[0]?.count||0)+(n[0]?.count||0)+(r[0]?.count||0),by_collection:{projects:c[0]?.count||0,companies:n[0]?.count||0,main_news:r[0]?.count||0},recent:l}})}catch(e){return console.error("Get stats error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.get("/:collection/:item_id/check",async(e,t)=>{try{const{collection:a,item_id:i}=e.params,{accountability:s}=e;if(!s?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const c=new o("favorites",{schema:e.schema,accountability:e.accountability}),n=await c.readByQuery({filter:{_and:[{user_created:{_eq:s.user}},{collection:{_eq:a}},{item_id:{_eq:i}}]},limit:1}),l=n.length>0;return t.json({favorited:l,favorite_id:l?n[0].id:null,date_created:l?n[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:a}=e,{collection:c}=e.query;if(!a?.user)throw new s("Authentication required");const n=new o("favorites",{schema:e.schema,accountability:e.accountability}),l={user_created:{_eq:a.user}};if(c){if(!r.includes(c))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});l.collection={_eq:c}}const u=await n.readByQuery({filter:l,limit:-1,fields:["id","collection","item_id"]});if(0===u.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const d=u.map(e=>e.id);await n.deleteMany(d);const m={};u.forEach(e=>{m[e.collection]||(m[e.collection]={}),m[e.collection][e.item_id]||(m[e.collection][e.item_id]=0),m[e.collection][e.item_id]++});for(const[e,t]of Object.entries(m))for(const[a,o]of Object.entries(t))try{await i(e).where("id",a).decrement("favorites_count",o)}catch(t){console.warn(`Could not decrement favorites_count for ${e}:`,t.message)}return t.json({success:!0,message:`Deleted ${u.length} favorite(s)`,deleted:u.length,collection:c||"all"})}catch(e){return console.error("Clear favorites error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}}),e.get("/",async(e,t)=>{try{const{accountability:a}=e,{collection:i,limit:c=50,offset:n=0,sort:l="-date_created"}=e.query;if(!a?.user)throw new s("You must be authenticated to view favorites");const u=new o("favorites",{schema:e.schema,accountability:e.accountability}),d={user_created:{_eq:a.user}};if(i){if(!r.includes(i))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${r.join(", ")}`});d.collection={_eq:i}}const m=await u.readByQuery({filter:d,sort:[l],limit:parseInt(c),offset:parseInt(n),fields:["*"]}),_=await u.readByQuery({filter:d,aggregate:{count:"*"}}),f={projects:[],companies:[],main_news:[]},p={projects:0,companies:0,main_news:0};for(const t of m)if(f[t.collection])try{const a=new o(t.collection,{schema:e.schema,accountability:e.accountability});let i=["id","status","date_created","date_updated","favorites_count"];"projects"===t.collection?i.push("title","slug","summary","featured_image.*","contract_value_usd","current_stage"):"companies"===t.collection?i.push("name","slug","company_type","logo.*","description"):"main_news"===t.collection&&i.push("title","slug","excerpt","featured_image.*","published_at");const s=await a.readOne(t.item_id,{fields:i});f[t.collection].push({favorite_id:t.id,favorite_date:t.date_created,favorite_notes:t.notes,favorite_tags:t.tags,...s}),p[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message)}return t.json({success:!0,total:_[0]?.count||0,limit:parseInt(c),offset:parseInt(n),counts:p,favorites:f})}catch(e){return console.error("Get favorites error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}})}},{name:"favourites",config:(e,{services:t,exceptions:a,database:i})=>{const{ItemsService:o}=t,{ForbiddenException:s,InvalidPayloadException:c,ServiceUnavailableException:n}=a,r=["projects","companies","main_news"];e.post("/toggle",async(e,t)=>{try{const{collection:a,item_id:n}=e.body,{accountability:l}=e;if(!l?.user)throw new s("You must be authenticated to manage favorites");if(!a||!n)throw new c("Collection and item_id are required");if(!r.includes(a))throw new c(`Invalid collection. Must be one of: ${r.join(", ")}`);const u=new o("favorites",{schema:e.schema,accountability:e.accountability}),d=new o(a,{schema:e.schema,accountability:e.accountability});try{await d.readOne(n)}catch(e){return t.status(404).json({success:!1,error:`Item not found in ${a}`})}const m=await u.readByQuery({filter:{_and:[{user_created:{_eq:l.user}},{collection:{_eq:a}},{item_id:{_eq:n}}]},limit:1});if(m.length>0){await u.deleteOne(m[0].id);try{await i(a).where("id",n).decrement("favorites_count",1)}catch(e){console.warn(`Could not decrement favorites_count for ${a}:`,e.message)}return t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"})}{const e=await u.createOne({collection:a,item_id:n});try{await i(a).where("id",n).increment("favorites_count",1)}catch(e){console.warn(`Could not increment favorites_count for ${a}:`,e.message)}return t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(e){return console.error("Toggle favorite error:",e),e instanceof s||e instanceof c?t.status(e.status||400).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:e.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:a}=e.body,{accountability:i}=e;if(!i?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!a||!Array.isArray(a)||0===a.length)return t.status(400).json({success:!1,error:"Items array is required"});if(a.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});for(const e of a){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!r.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const s=new o("favorites",{schema:e.schema,accountability:e.accountability}),c=a.map(e=>({_and:[{user_created:{_eq:i.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),n=await s.readByQuery({filter:{_or:c},limit:-1}),l={};return a.forEach(e=>{const t=`${e.collection}:${e.item_id}`,a=n.find(t=>t.collection===e.collection&&t.item_id===e.item_id);l[t]={collection:e.collection,item_id:e.item_id,favorited:!!a,favorite_id:a?.id||null,date_created:a?.date_created||null}}),t.json({success:!0,authenticated:!0,total:a.length,favorited_count:n.length,results:l})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:a}=e.params,{limit:i=10,period:s="all"}=e.query;if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const c=new o(a,{schema:e.schema,accountability:e.accountability});let n={};if("all"!==s){const e=new Date;let t;switch(s){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(n.date_created={_gte:t.toISOString()})}const l=(await c.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...n},sort:["-favorites_count","-date_created"],limit:parseInt(i)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:a,period:s,total:l.length,popular:l})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:a}=e;if(!a?.user)throw new s("Authentication required");const i=new o("favorites",{schema:e.schema,accountability:e.accountability}),c=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),n=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),r=await i.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"main_news"}},aggregate:{count:"*"}}),l=await i.readByQuery({filter:{user_created:{_eq:a.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(c[0]?.count||0)+(n[0]?.count||0)+(r[0]?.count||0),by_collection:{projects:c[0]?.count||0,companies:n[0]?.count||0,main_news:r[0]?.count||0},recent:l}})}catch(e){return console.error("Get stats error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.get("/:collection/:item_id/check",async(e,t)=>{try{const{collection:a,item_id:i}=e.params,{accountability:s}=e;if(!s?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const c=new o("favorites",{schema:e.schema,accountability:e.accountability}),n=await c.readByQuery({filter:{_and:[{user_created:{_eq:s.user}},{collection:{_eq:a}},{item_id:{_eq:i}}]},limit:1}),l=n.length>0;return t.json({favorited:l,favorite_id:l?n[0].id:null,date_created:l?n[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:a}=e,{collection:c}=e.query;if(!a?.user)throw new s("Authentication required");const n=new o("favorites",{schema:e.schema,accountability:e.accountability}),l={user_created:{_eq:a.user}};if(c){if(!r.includes(c))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});l.collection={_eq:c}}const u=await n.readByQuery({filter:l,limit:-1,fields:["id","collection","item_id"]});if(0===u.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const d=u.map(e=>e.id);await n.deleteMany(d);const m={};u.forEach(e=>{m[e.collection]||(m[e.collection]={}),m[e.collection][e.item_id]||(m[e.collection][e.item_id]=0),m[e.collection][e.item_id]++});for(const[e,t]of Object.entries(m))for(const[a,o]of Object.entries(t))try{await i(e).where("id",a).decrement("favorites_count",o)}catch(t){console.warn(`Could not decrement favorites_count for ${e}:`,t.message)}return t.json({success:!0,message:`Deleted ${u.length} favorite(s)`,deleted:u.length,collection:c||"all"})}catch(e){return console.error("Clear favorites error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}}),e.get("/",async(e,t)=>{try{const{accountability:a}=e,{collection:i,limit:c=50,offset:n=0,sort:l="-date_created"}=e.query;if(!a?.user)throw new s("You must be authenticated to view favorites");const u=new o("favorites",{schema:e.schema,accountability:e.accountability}),d={user_created:{_eq:a.user}};if(i){if(!r.includes(i))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${r.join(", ")}`});d.collection={_eq:i}}const m=await u.readByQuery({filter:d,sort:[l],limit:parseInt(c),offset:parseInt(n),fields:["*"]}),_=await u.readByQuery({filter:d,aggregate:{count:"*"}}),f={projects:[],companies:[],main_news:[]},p={projects:0,companies:0,main_news:0};for(const t of m)if(f[t.collection])try{const a=new o(t.collection,{schema:e.schema,accountability:e.accountability});let i=["id","status","date_created","date_updated","favorites_count"];"projects"===t.collection?i.push("title","slug","summary","featured_image.*","contract_value_usd","current_stage"):"companies"===t.collection?i.push("name","slug","company_type","logo.*","description"):"main_news"===t.collection&&i.push("title","slug","excerpt","featured_image.*","published_at");const s=await a.readOne(t.item_id,{fields:i});f[t.collection].push({favorite_id:t.id,favorite_date:t.date_created,favorite_notes:t.notes,favorite_tags:t.tags,...s}),p[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message)}return t.json({success:!0,total:_[0]?.count||0,limit:parseInt(c),offset:parseInt(n),counts:p,favorites:f})}catch(e){return console.error("Get favorites error:",e),e instanceof s?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}})}}],a=[];export{t as endpoints,e as hooks,a as operations};
