const e=[{name:"recent-view-hook",config:({action:e},{services:t,database:i,getSchema:a})=>{const{ItemsService:s}=t;async function o(e,t,i){try{const{payload:o,query:r}=t;let n=null;r?.filter?.id?._eq?n=r.filter.id._eq:o&&Array.isArray(o)&&1===o.length&&o[0]?.id&&(n=o[0].id),n?(await async function(e,t,i){try{if(!i?.user)return void console.log("No authenticated user, skipping tracking");const o=await a(),r=new s("recent_views",{schema:o,accountability:i});console.log("Recent views service created",i.user,e,t);const n=await r.readByQuery({filter:{_and:[{user_created:{_eq:i.user}},{collection:{_eq:e}},{item_id:{_eq:t}}]},limit:1});console.log("Existing view check result:",n);const c=(new Date).toISOString();if(n.length>0){const i=await r.updateOne(n[0].id,{date_updated:c});console.log(`Updated recent view for ${e}:${t}`,i)}else{const a=await r.createOne({collection:e,item_id:t,date_updated:c});console.log(`Created recent view for ${e}:${t}`,a),await async function(e,t,i=100){try{const a=await t.readByQuery({filter:{user_created:{_eq:e}},sort:["-date_updated"],limit:-1,fields:["id","date_updated"]});if(a.length>i){const s=a.slice(i),o=s.map(e=>e.id);await t.deleteMany(o),console.log(`Cleaned up ${s.length} old recent views for user ${e}`)}}catch(e){console.error("Error enforcing recent views limit:",e)}}(i.user,r)}}catch(e){console.error("Error tracking recent view:",e),console.error("Error stack:",e.stack)}}(e,n,i),console.log(`Tracked single item view: ${e}:${n}`)):console.log(`Skipped tracking for ${e} - list view or multiple items`)}catch(t){console.error(`Error handling ${e} read:`,t)}}console.log("Recent Views Action Hook: Registered"),e("projects.items.read",async(e,t)=>{await o("projects",e,t.accountability)}),e("companies.items.read",async(e,t)=>{await o("companies",e,t.accountability)}),e("projects_tenders.items.read",async(e,t)=>{await o("projects_tenders",e,t.accountability)}),e("main_news.items.read",async(e,t)=>{await o("main_news",e,t.accountability)}),e("experts_analysts.items.read",async(e,t)=>{await o("experts_analysts",e,t.accountability)})}},{name:"favorites-counter",config:({filter:e,action:t})=>{t("favorites.items.create",async({payload:e},{database:t})=>{const{collection:i,item_id:a}=e;await t(i).where("id",a).increment("favorites_count",1)}),t("favorites.items.delete",async({keys:e},{database:t})=>{const i=await t("favorites").whereIn("id",e).select("collection","item_id");for(const e of i)await t(e.collection).where("id",e.item_id).decrement("favorites_count",1)})}},{name:"slug",config:({action:e},{services:t,getSchema:i})=>{const{ItemsService:a}=t;console.log("Auto Slug Hook: Registered and listening for events");const s={projects:{sourceField:"title",slugField:"slug",unique:!0,maxLength:100},companies:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100},main_news:{sourceField:"title",slugField:"slug",unique:!0,maxLength:100},projects_tenders:{sourceField:"title",slugField:"slug",unique:!0,maxLength:100},experts_analysts:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100},blog:{sourceField:"title",slugField:"slug",unique:!0,maxLength:100},events:{sourceField:"title",slugField:"slug",unique:!0,maxLength:100},countries:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100},sectors:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100},regions:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100},project_status:{sourceField:"name",slugField:"slug",unique:!0,maxLength:100}};async function o(e,t,o,r){try{console.log(`Auto Slug: Processing ${r} for ${e}`,t);const n=s[e];if(!n)return;const c=await i(),l=new a(e,{schema:c,accountability:o});let d;if("create"===r)d=t.payload;else if("update"===r){d={...await l.readOne(t.key,{fields:[n.slugField,n.sourceField]}),...t.payload}}if(d[n.slugField]&&""!==d[n.slugField].trim())return void console.log(`Auto Slug: ${e} already has slug: ${d[n.slugField]}`);const u=d[n.sourceField];if(!u||""===u.trim())return void console.warn(`Auto Slug: Cannot generate slug for ${e} - source field "${n.sourceField}" is empty`);console.log(`Auto Slug: Generating slug for ${e} from: "${u}"`);let m=function(e,t=100){if(!e)return"";let i=e.toLowerCase();i=i.replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,""),i.length>t&&(i=i.substring(0,t),i.endsWith("-")&&(i=i.substring(0,i.length-1)));i&&""!==i.trim()||(i="item-"+Date.now());return i}(u,n.maxLength),_=m;n.unique&&(_=await async function(e,t,i,a,s=null){let o=i,r=1,n=!1;for(;!n&&r<100;)try{const e=await a.readByQuery({filter:{[t]:{_eq:o}},limit:1,fields:["id"]});e.length>0&&(!s||e[0].id!==s)?(o=`${i}-${r}`,r++):n=!0}catch(t){console.error(`Auto Slug: Error checking slug uniqueness for ${e}:`,t),n=!0}return o}(e,n.slugField,m,l,t.key)),console.log(`Auto Slug: Generated slug for ${e}: ${_}`),("create"===r||"update"===r)&&(t.payload[n.slugField]=_)}catch(t){console.error(`Auto Slug: Error generating slug for ${e}:`,t)}}Object.keys(s).forEach(t=>{e(`${t}.items.create`,async(e,{accountability:i})=>{await o(t,e,i,"create")}),e(`${t}.items.update`,async(e,{accountability:i})=>{await o(t,e,i,"update")})})}}],t=[{name:"projects",config:(e,{services:t,exceptions:i,getSchema:a})=>{const{ItemsService:s,AssetsService:o}=t;function r(e,t="id"){return e&&Array.isArray(e)?e.map(e=>{const i=e[`${t}_id`]||e;return i&&i.id?{id:i.id,name:i.name||"Unnamed"}:null}).filter(Boolean):[]}e.get("/",async(e,t,i)=>{try{const{accountability:i}=e,o=await a(),r=new s("projects",{schema:o,accountability:e.accountability}),n=e.query.groupBy,c=parseInt(e.query.limit)||25,l=parseInt(e.query.page)||1,d=await r.readByQuery({fields:["id","title","slug","contract_value_usd","summary","description","estimated_project_value_usd","value_range","construction_start_date","location","current_stage","email","countries.countries_id.id","countries.countries_id.name","regions.regions_id.id","regions.regions_id.name","types.types_id.id","sectors.sectors_id.name","sectors.sectors_id.id","types.types_id.name","countries.countries_id.slug","sectors.sectors_id.slug","regions.regions_id.slug","featured_image","featured_image.id","featured_image.filename_disk","featured_image.title","featured_image.filesize"],limit:n?-1:c,offset:n?0:(l-1)*c,filter:e.query.filter||{},meta:["total_count","filter_count"]}),u=d.data||d,m=d.meta||{};console.log("Directus meta:",m);const _=u.map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,e.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`);const t=e.countries?[...e.countries]:[],i=e.regions?[...e.regions]:[],a=e.types?[...e.types]:[],s=e.sectors?[...e.sectors]:[];return e.countries&&Array.isArray(e.countries)&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean)),e.regions&&Array.isArray(e.regions)&&(e.regions=e.regions.map(e=>e.regions_id).filter(Boolean)),e.types&&Array.isArray(e.types)&&(e.types=e.types.map(e=>e.types_id).filter(Boolean)),e.sectors&&Array.isArray(e.sectors)&&(e.sectors=e.sectors.map(e=>e.sectors_id).filter(Boolean)),n&&(e._originals={countries:t,regions:i,types:a,sectors:s}),e});if(n){const i=function(e,t){const i=new Map;return e.forEach(e=>{let a=[];switch(t){case"country":a=e._originals.countries.map(e=>({id:e.countries_id?.id,name:e.countries_id?.name||"Unknown Country",data:e.countries_id}));break;case"region":a=e._originals.regions.map(e=>({id:e.regions_id?.id,name:e.regions_id?.name||"Unknown Region",data:e.regions_id}));break;case"sector":a=e._originals.sectors.map(e=>({id:e.sectors_id?.id,name:e.sectors_id?.name||"Unknown Region",data:e.sectors_id}));break;case"type":a=e._originals.types.map(e=>({id:e.types_id?.id,name:e.types_id?.name||"Unknown Type",data:e.types_id}));break;case"company":a=e._originals.companies.map(e=>({id:e.companies_id?.id,name:e.companies_id?.name||"Unknown Company",data:e.companies_id}));break;default:a=[{id:"all",name:"All Projects",data:null}]}0===a.length&&(a=[{id:"unknown",name:`Unknown ${t}`,data:null}]),a.forEach(t=>{i.has(t.id)||i.set(t.id,{id:t.id,name:t.name,data:t.data,projects:[],count:0,totalValue:0});const a=i.get(t.id),s={...e};delete s._originals,a.projects.push(s),a.count++,e.contract_value_usd&&(a.totalValue+=parseFloat(e.contract_value_usd)||0)})}),Array.from(i.values()).sort((e,t)=>e.name.localeCompare(t.name))}(_,n),a=parseInt(e.query.limit)||5,s=parseInt(e.query.page)||1,o=i.length,r=(s-1)*a,c=r+a,l=i.slice(r,c);t.json({data:l,meta:{total_groups:o,groupBy:n,page:s,limit:a,page_count:Math.ceil(o/a)}})}else{let a=_;a=i?.user?await async function(e,t,i,a){if(!e||0===e.length)return e;try{const o=new s("favourites",{schema:i,accountability:a}),r=e.map(e=>e.id),n=await o.readByQuery({filter:{_and:[{user_created:{_eq:t}},{collection:{_eq:"projects"}},{item_id:{_in:r}}]},fields:["id","item_id"],limit:-1}),c=new Map;return n.forEach(e=>{c.set(e.item_id,e.id)}),e.map(e=>({...e,is_favorited:c.has(e.id),favorite_id:c.get(e.id)||null}))}catch(e){throw console.error("Error in addFavoritesStatus:",e),e}}(_,i.user,o,e.accountability):_.map(e=>({...e,is_favorited:!1,favorite_id:null})),t.json({data:a,meta:{total_count:m.total_count,filter_count:m.filter_count,page:l,limit:c,page_count:Math.ceil(m.total_count/c),authenticated:!!i?.user}})}}catch(e){console.log("projects error: ",e),i(e)}}),e.get("/public/recent",async(e,t,i)=>{try{const i=new s("projects",{schema:e.schema,accountability:null}),a=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","title","slug","summary","description","current_stage","contract_value_usd","sectors.sectors_id.name","sectors.sectors_id.id","sectors.sectors_id.slug","countries.countries_id.id","countries.countries_id.name","countries.countries_id.slug","regions.regions_id.id","regions.regions_id.name","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:a,sort:["-date_created"],filter:{status:{_eq:"published"}}}),n=(o.data||o).map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title});const t=r(e.sectors,"sectors"),i=r(e.countries,"countries"),a=r(e.regions,"regions");return{id:e.id,title:e.title,slug:e.slug,summary:e.summary,description:e.description,current_stage:e.current_stage,contract_value_usd:e.contract_value_usd,location:e.location,date_created:e.date_created,featured_image:e.featured_image,sectors:t,countries:i,regions:a}});t.json({data:n,meta:{total:n.length}})}catch(e){i(e)}}),e.get("/public/trending",async(e,t,i)=>{try{const i=new s("projects",{schema:e.schema,accountability:null}),a=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","title","slug","summary","description","current_stage","contract_value_usd","sectors.sectors_id.name","sectors.sectors_id.id","sectors.sectors_id.slug","countries.countries_id.id","countries.countries_id.name","countries.countries_id.slug","regions.regions_id.id","regions.regions_id.name","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:a,sort:["-date_created"],filter:{status:{_eq:"published"},is_trending:{_eq:!0}}}),n=o.data||o,c=n.map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title});const t=r(e.sectors,"sectors"),i=r(e.countries,"countries"),a=r(e.regions,"regions");return{id:e.id,title:e.title,slug:e.slug,summary:e.summary,description:e.description,current_stage:e.current_stage,contract_value_usd:e.contract_value_usd,location:e.location,date_created:e.date_created,featured_image:e.featured_image,sectors:t,countries:i,regions:a}});t.json({data:c,meta:{total:n.length}})}catch(e){console.log("trending error: ",e),i(e)}}),e.get("/:id",async(e,t,i)=>{try{const i=await a(),{accountability:o}=e,n=e.params.id,c=new s("projects",{schema:i,accountability:e.accountability}),l=await c.readOne(n,{fields:["*","countries.countries_id.id","countries.countries_id.name","countries.countries_id.slug","sectors.sectors_id.slug","regions.regions_id.slug","regions.regions_id.id","regions.regions_id.name","types.types_id.id","sectors.sectors_id.name","sectors.sectors_id.id","types.types_id.name","funding.funding_id.*","client_owner.companies_id.*","developer.companies_id.*","companies.companies_id.*","authority.companies_id.id","authority.companies_id.name","architect.companies_id.id","architect.companies_id.name","design_consultant.companies_id.id","design_consultant.companies_id.name","project_manager.companies_id.id","project_manager.companies_id.name","civil_engineer.companies_id.id","civil_engineer.companies_id.name","structural_engineer.companies_id.id","structural_engineer.companies_id.name","mep_engineer.companies_id.id","mep_engineer.companies_id.name","electrical_engineer.companies_id.id","electrical_engineer.companies_id.name","geotechnical_engineer.companies_id.id","geotechnical_engineer.companies_id.name","cost_consultants.companies_id.id","cost_consultants.companies_id.name","quantity_surveyor.companies_id.id","quantity_surveyor.companies_id.name","landscape_architect.companies_id.id","landscape_architect.companies_id.name","legal_adviser.companies_id.id","legal_adviser.companies_id.name","transaction_advisor.companies_id.id","transaction_advisor.companies_id.name","study_consultant.companies_id.id","study_consultant.companies_id.name","main_contractor.companies_id.id","main_contractor.companies_id.name","main_contract_bidder.companies_id.id","main_contract_bidder.companies_id.name","main_contract_prequalified.companies_id.id","main_contract_prequalified.companies_id.name","mep_subcontractor.companies_id.id","mep_subcontractor.companies_id.name","piling_subcontractor.companies_id.id","piling_subcontractor.companies_id.name","facade_subcontractor.companies_id.id","facade_subcontractor.companies_id.name","lift_subcontractor.companies_id.id","lift_subcontractor.companies_id.name","other_subcontractor.companies_id.id","other_subcontractor.companies_id.name","operator.companies_id.id","operator.companies_id.name","feed.companies_id.id","feed.companies_id.name","featured_image.*","news.*"]});l.featured_image&&"object"==typeof l.featured_image&&l.featured_image.id&&(l.featured_image.url=`${process.env.PUBLIC_URL}/assets/${l.featured_image.id}`,l.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${l.featured_image.id}?width=400&height=300&fit=cover`),l.countries&&Array.isArray(l.countries)&&(l.countries=l.countries.map(e=>e.countries_id).filter(Boolean)),l.regions&&Array.isArray(l.regions)&&(l.regions=l.regions.map(e=>e.regions_id).filter(Boolean)),l.types&&Array.isArray(l.types)&&(l.types=l.types.map(e=>e.types_id).filter(Boolean)),l.funding&&Array.isArray(l.funding)&&(l.funding=l.funding.map(e=>e.funding_id).filter(Boolean)),l.companies&&Array.isArray(l.companies)&&(l.companies=l.companies.map(e=>e.companies_id).filter(Boolean)),l.client_owner&&Array.isArray(l.client_owner)&&(l.client_owner=l.client_owner.map(e=>e.companies_id).filter(Boolean)),l.developer&&Array.isArray(l.developer)&&(l.developer=l.developer.map(e=>e.companies_id).filter(Boolean)),l.developer=r(l.developer,"companies"),l.authority=r(l.authority,"companies"),l.architect=r(l.architect,"companies"),l.design_consultant=r(l.design_consultant,"companies"),l.project_manager=r(l.project_manager,"companies"),l.civil_engineer=r(l.civil_engineer,"companies"),l.structural_engineer=r(l.structural_engineer,"companies"),l.mep_engineer=r(l.mep_engineer,"companies"),l.electrical_engineer=r(l.electrical_engineer,"companies"),l.geotechnical_engineer=r(l.geotechnical_engineer,"companies"),l.cost_consultants=r(l.cost_consultants,"companies"),l.quantity_surveyor=r(l.quantity_surveyor,"companies"),l.landscape_architect=r(l.landscape_architect,"companies"),l.legal_adviser=r(l.legal_adviser,"companies"),l.transaction_advisor=r(l.transaction_advisor,"companies"),l.study_consultant=r(l.study_consultant,"companies"),l.funding=r(l.funding,"companies"),l.main_contractor=r(l.main_contractor,"companies"),l.main_contract_bidder=r(l.main_contract_bidder,"companies"),l.main_contract_prequalified=r(l.main_contract_prequalified,"companies"),l.mep_subcontractor=r(l.mep_subcontractor,"companies"),l.piling_subcontractor=r(l.piling_subcontractor,"companies"),l.facade_subcontractor=r(l.facade_subcontractor,"companies"),l.lift_subcontractor=r(l.lift_subcontractor,"companies"),l.other_subcontractor=r(l.other_subcontractor,"companies"),l.operator=r(l.operator,"companies"),l.feed=r(l.feed,"companies");let d=!1,u=null;if(o?.user)try{const e=new s("favourites",{schema:i,accountability:o}),t=await e.readByQuery({filter:{_and:[{user_created:{_eq:o.user}},{collection:{_eq:"projects"}},{item_id:{_eq:n}}]},limit:1});t.length>0&&(d=!0,u=t[0].id)}catch(e){console.warn("Failed to fetch favorite status:",e.message)}const m={...l,is_favorited:d,favorite_id:u,authenticated:!!o?.user};return t.json({data:m})}catch(e){console.error("Project by ID error:",e),i(e)}})}},{name:"favourites",config:(e,t)=>{const{services:i,exceptions:a,database:s,env:o,logger:r,getSchema:n}=t,{ItemsService:c}=i,l=["projects","companies","main_news","projects_tenders","blog","experts_analysts"];function d(e,t){if(t&&e)try{const i=t.split(".");let a=e;for(const e of i){if(!a||"object"!=typeof a||!(e in a))return;a=a[e]}return a}catch(e){return void console.warn(`Error getting field ${t}:`,e)}}e.post("/toggle",async(e,t)=>{try{const{collection:i,item_id:a}=e.body,{accountability:o}=e;if(console.log("Toggle request:",{collection:i,item_id:a,user:o?.user}),!o?.user)return t.status(403).json({success:!1,error:"You must be authenticated to manage favorites"});if(!i||!a)return t.status(400).json({success:!1,error:"Collection and item_id are required"});if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const r=await n(),d=new c("favourites",{schema:r,accountability:e.accountability});console.log(`Proceeding without item existence check for ${i}:${a}`);const u=await d.readByQuery({filter:{_and:[{user_created:{_eq:o.user}},{collection:{_eq:i}},{item_id:{_eq:a}}]},limit:1});if(u.length>0){await d.deleteOne(u[0].id);try{await s(i).where("id",a).decrement("favorites_count",1)}catch(e){console.warn(`Could not decrement favorites_count for ${i}:`,e.message)}return t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"})}{const e=await d.createOne({collection:i,item_id:a});try{await s(i).where("id",a).increment("favorites_count",1)}catch(e){console.warn(`Could not increment favorites_count for ${i}:`,e.message)}return t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(i){return console.error("Toggle favorite error:",i),i.message.includes("foreign key")||i.message.includes("constraint")?t.status(404).json({success:!1,error:`Item not found in ${e.body.collection}`}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:i.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:i}=e.body,{accountability:a}=e;if(!a?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!i||!Array.isArray(i)||0===i.length)return t.status(400).json({success:!1,error:"Items array is required"});if(i.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});for(const e of i){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!l.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const s=new c("favorites",{schema:await n(),accountability:e.accountability}),o=i.map(e=>({_and:[{user_created:{_eq:a.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),r=await s.readByQuery({filter:{_or:o},limit:-1}),d={};return i.forEach(e=>{const t=`${e.collection}:${e.item_id}`,i=r.find(t=>t.collection===e.collection&&t.item_id===e.item_id);d[t]={collection:e.collection,item_id:e.item_id,favorited:!!i,favorite_id:i?.id||null,date_created:i?.date_created||null}}),t.json({success:!0,authenticated:!0,total:i.length,favorited_count:r.length,results:d})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:i}=e.params,{limit:a=10,period:s="all"}=e.query;if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const o=new c(i,{schema:await n(),accountability:e.accountability});let r={};if("all"!==s){const e=new Date;let t;switch(s){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(r.date_created={_gte:t.toISOString()})}const d=(await o.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...r},sort:["-favorites_count","-date_created"],limit:parseInt(a)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:i,period:s,total:d.length,popular:d})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:i}=e;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const a=new c("favourites",{schema:await n(),accountability:e.accountability}),s=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),o=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),r=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"main_news"}},aggregate:{count:"*"}}),l=await a.readByQuery({filter:{user_created:{_eq:i.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(s[0]?.count||0)+(o[0]?.count||0)+(r[0]?.count||0),by_collection:{projects:s[0]?.count||0,companies:o[0]?.count||0,main_news:r[0]?.count||0},recent:l}})}catch(e){return console.error("Get stats error:",e),t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.get("/:collection/:item_id/check",async(e,t)=>{try{const{collection:i,item_id:a}=e.params,{accountability:s}=e;if(!s?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const o=new c("favourites",{schema:await n(),accountability:e.accountability}),r=await o.readByQuery({filter:{_and:[{user_created:{_eq:s.user}},{collection:{_eq:i}},{item_id:{_eq:a}}]},limit:1}),d=r.length>0;return t.json({favorited:d,favorite_id:d?r[0].id:null,date_created:d?r[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:i}=e,{collection:a}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const o=new c("favourites",{schema:await n(),accountability:e.accountability}),r={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});r.collection={_eq:a}}const d=await o.readByQuery({filter:r,limit:-1,fields:["id","collection","item_id"]});if(0===d.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const u=d.map(e=>e.id);await o.deleteMany(u);const m={};d.forEach(e=>{m[e.collection]||(m[e.collection]={}),m[e.collection][e.item_id]||(m[e.collection][e.item_id]=0),m[e.collection][e.item_id]++});for(const[e,t]of Object.entries(m))for(const[i,a]of Object.entries(t))try{await s(e).where("id",i).decrement("favorites_count",a)}catch(t){console.warn(`Could not decrement favorites_count for ${e}:`,t.message)}return t.json({success:!0,message:`Deleted ${d.length} favorite(s)`,deleted:d.length,collection:a||"all"})}catch(e){return console.error("Clear favorites error:",e),t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}}),e.get("/",async(e,t)=>{try{const{accountability:i}=e,{collection:a,limit:s=100,offset:o=0,sort:r="-date_created"}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"You must be authenticated to view favorites"});const u=await n(),m=new c("favourites",{schema:u,accountability:e.accountability}),_={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${l.join(", ")}`});_.collection={_eq:a}}console.log("Fetching favorites with filter:",JSON.stringify(_));const g=await m.readByQuery({filter:_,sort:[r],limit:parseInt(s),offset:parseInt(o),fields:["*"]});if(console.log("Favorites result count:",g.length),!Array.isArray(g))return console.error("Favorites is not an array:",typeof g,g),t.status(500).json({success:!1,error:"Invalid response format from favorites service"});let p=0;try{const e=await m.readByQuery({filter:_,aggregate:{count:["*"]}});Array.isArray(e)&&e.length>0?p=e[0]?.count||0:e&&"object"==typeof e&&(p=e.count||0),console.log("Total count:",p)}catch(e){console.warn("Could not get total count:",e.message),p=g.length}const f=[],y={projects:0,companies:0,main_news:0,projects_tenders:0,experts_analysts:0,blog:0};if(g.length>0)for(const t of g)if(t.collection&&t.item_id)try{const i=new c(t.collection,{schema:u,accountability:e.accountability});let a=["id","status"];const s={projects:{title:"title",image:"featured_image",summary:"summary",slug:"slug",date:"date_created",current_stage:"current_stage",contract_value_usd:"contract_value_usd",location:"location",countries:"countries.countries_id.*",sectors:"sectors.sectors_id.*",regions:"regions.regions_id.*"},companies:{title:"name",image:"logo",summary:"description",slug:"slug",date:"date_created",company_role:"company_role",countries:"countries.countries_id.*",sectors:"sectors.sectors_id.*"},main_news:{title:"title",image:"featured_image",summary:"summary",slug:"slug",date:"date_created",category:"category",author:"author"},projects_tenders:{title:"title",image:"featured_image",summary:"summary",slug:"slug",date:"date_created",tender_type:"tender_type",countries:"countries.countries_id.*",sectors:"sectors.sectors_id.*"},experts_analysts:{title:"name",image:"photo",summary:"bio",slug:"slug",date:"date_created",title_role:"title",expertise:"expertise"},blog:{title:"title",image:"featured_image",summary:"summary",slug:"slug",date:"date_created",category:"category",author:"author"}}[t.collection];if(s){const e=Object.values(s);a=[...new Set([...a,...e])]}console.log(`Fetching ${t.collection} item ${t.item_id} with fields:`,a);const o=await i.readOne(t.item_id,{fields:a});if(o){const e=(e,t="id")=>e&&Array.isArray(e)?e.map(e=>{const i=e[`${t}_id`]||e;return i&&i.id?{id:i.id,name:i.name||"Unnamed",slug:i.slug,...i.flag&&{flag:i.flag},...i.code&&{code:i.code},...i.icon&&{icon:i.icon},...i.color&&{color:i.color}}:null}).filter(Boolean):[];let i=[],a=[],r=[];"projects"!==t.collection&&"projects_tenders"!==t.collection&&"companies"!==t.collection||(i=e(o.countries,"countries"),a=e(o.sectors,"sectors"),"projects"===t.collection&&(r=e(o.regions,"regions")));let n=d(o,s?.image);n&&"object"==typeof n&&n.id&&(n={id:n.id,url:`${process.env.PUBLIC_URL}/assets/${n.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${n.id}?width=400&height=300&fit=cover`,title:n.title,...n});const c={id:o.id,collection:t.collection,favorite_id:t.id,favorite_date:t.date_created,title:d(o,s?.title),image:n,summary:d(o,s?.summary),slug:d(o,s?.slug),status:o.status,date_created:d(o,s?.date),..."projects"===t.collection&&{current_stage:o.current_stage,contract_value_usd:o.contract_value_usd,location:o.location,countries:i,sectors:a,regions:r,primary_country:i.length>0?i[0]:null,primary_sector:a.length>0?a[0]:null},..."companies"===t.collection&&{company_role:o.company_role,countries:i,sectors:a,primary_country:i.length>0?i[0]:null,primary_sector:a.length>0?a[0]:null},..."projects_tenders"===t.collection&&{tender_type:o.tender_type,countries:i,sectors:a,primary_country:i.length>0?i[0]:null,primary_sector:a.length>0?a[0]:null},..."main_news"===t.collection&&{category:o.category,author:o.author},..."experts_analysts"===t.collection&&{title_role:o.title,expertise:o.expertise},..."blog"===t.collection&&{category:o.category,author:o.author},...(i.length>0||a.length>0||r.length>0)&&{stats:{...i.length>0&&{countries_count:i.length},...a.length>0&&{sectors_count:a.length},...r.length>0&&{regions_count:r.length}}}};Object.keys(c).forEach(e=>{void 0===c[e]&&delete c[e]}),f.push(c),y[t.collection]++,console.log(`Added ${t.collection} item to results:`,c.title)}else console.warn(`Item not found: ${t.collection} - ${t.item_id}`)}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message),f.push({id:t.item_id,collection:t.collection,favorite_id:t.id,favorite_date:t.date_created,title:`Item ${t.item_id}`,status:"unavailable",error:"Item could not be loaded"}),y[t.collection]++}else console.warn("Invalid favorite item:",t);const h={projects:f.filter(e=>"projects"===e.collection),companies:f.filter(e=>"companies"===e.collection),news:f.filter(e=>"main_news"===e.collection),tenders:f.filter(e=>"projects_tenders"===e.collection),opinions:f.filter(e=>"experts_analysts"===e.collection),blog:f.filter(e=>"blog"===e.collection)};return console.log("Final results count:",f.length),console.log("Collection counts:",y),t.json({success:!0,total:p,limit:parseInt(s),offset:parseInt(o),counts:y,data:f,group:h})}catch(e){return console.error("Get favorites error:",e),t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}})}},{name:"recent-views",config:(e,t)=>{const{services:i,exceptions:a,database:s,env:o,logger:r,getSchema:n}=t,{ItemsService:c}=i,l=["projects","companies","main_news","projects_tenders"];e.get("/",async(e,t)=>{try{const{accountability:i}=e,{collection:a,limit:s=20,offset:o=0}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"You must be authenticated to view recent history"});const r=await n(),d=new c("recent_views",{schema:r,accountability:e.accountability}),u={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${l.join(", ")}`});u.collection={_eq:a}}const m=await d.readByQuery({filter:u,sort:["-date_updated","-date_created"],limit:parseInt(s),offset:parseInt(o)}),_=await d.readByQuery({filter:u,aggregate:{count:["*"]}}),g={projects:[],companies:[]},p={projects:0,companies:0};for(const t of m)if(g[t.collection])try{const i=new c(t.collection,{schema:r,accountability:e.accountability});let a=["id","status","date_created","date_updated"];"projects"===t.collection?a.push("title","slug","summary","featured_image","contract_value_usd","current_stage"):"companies"===t.collection&&a.push("name","slug","company_role","logo","description");const s=await i.readOne(t.item_id,{fields:a});g[t.collection].push({view_id:t.id,view_date:t.date_created,last_viewed:t.date_updated,...s}),p[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message);try{await d.deleteOne(t.id)}catch(e){console.warn(`Could not delete orphaned recent view ${t.id}:`,e.message)}}return t.json({success:!0,total:_[0]?.count||0,limit:parseInt(s),offset:parseInt(o),counts:p,recent_views:g})}catch(e){return console.error("Get recent views error:",e),t.status(500).json({success:!1,error:"Failed to fetch recent views",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:i}=e,{collection:a}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const s=await n(),o=new c("recent_views",{schema:s,accountability:e.accountability}),r={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});r.collection={_eq:a}}const d=await o.readByQuery({filter:r,limit:-1,fields:["id"]});if(0===d.length)return t.json({success:!0,message:"No recent views to delete",deleted:0});const u=d.map(e=>e.id);return await o.deleteMany(u),t.json({success:!0,message:`Deleted ${d.length} recent view(s)`,deleted:d.length,collection:a||"all"})}catch(e){return console.error("Clear recent views error:",e),t.status(500).json({success:!1,error:"Failed to clear recent views",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:i}=e,{period:a="week"}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const s=await n(),o=new c("recent_views",{schema:s,accountability:e.accountability}),r=new Date;let l;switch(a){case"day":l=new Date(r.setDate(r.getDate()-1));break;case"week":default:l=new Date(r.setDate(r.getDate()-7));break;case"month":l=new Date(r.setMonth(r.getMonth()-1))}const d=await o.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"projects"},date_created:{_gte:l.toISOString()}},aggregate:{count:["*"]}}),u=await o.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"companies"},date_created:{_gte:l.toISOString()}},aggregate:{count:["*"]}}),m=await o.readByQuery({filter:{user_created:{_eq:i.user},date_created:{_gte:l.toISOString()}},aggregate:{groupBy:["collection","item_id"],count:["*"]},sort:["-count"],limit:5});return t.json({success:!0,period:a,stats:{total:(d[0]?.count||0)+(u[0]?.count||0),by_collection:{projects:d[0]?.count||0,companies:u[0]?.count||0},start_date:l.toISOString(),frequent_items:m}})}catch(e){return console.error("Get recent views stats error:",e),t.status(500).json({success:!1,error:"Failed to fetch recent views statistics",details:e.message})}})}},{name:"search",config:(e,t)=>{const{services:i,exceptions:a,database:s,env:o,logger:r,getSchema:n}=t,{ItemsService:c}=i,l={projects:{fields:["title","summary"],searchFields:["title","summary"],displayFields:{title:"title",type:"project",image:"featured_image",summary:"summary",slug:"slug"},weight:1},companies:{fields:["name","description"],searchFields:["name","description"],displayFields:{title:"name",type:"company",image:"logo",summary:"description",slug:"slug"},weight:.9},main_news:{fields:["title","summary"],searchFields:["title","summary"],displayFields:{title:"title",type:"news",image:"featured_image",summary:"summary",slug:"slug"},weight:.8},projects_tenders:{fields:["title","summary"],searchFields:["title","summary"],displayFields:{title:"title",type:"tenders",image:"featured_image",summary:"summary",slug:"slug"},weight:.7},experts_analysts:{fields:["name","title"],searchFields:["name","title"],displayFields:{title:"name",type:"opinions",image:"photo",summary:"bio",slug:"slug"},weight:.6},blog:{fields:["title","summary"],searchFields:["title","summary"],displayFields:{title:"title",type:"blog",image:"featured_image",summary:"summary",slug:"slug"},weight:.5}};function d(e,t,i){const a={},s=t.toLowerCase();return i.forEach(t=>{const i=e[t];if(i&&"string"==typeof i){i.toLowerCase().includes(s)&&(a[t]=i)}}),a}function u(e,t){if(t&&e)try{const i=t.split(".");let a=e;for(const e of i){if(!a||"object"!=typeof a||!(e in a))return;a=a[e]}return a}catch(e){return void console.warn(`Error getting field ${t}:`,e)}}e.get("/",async(e,t)=>{try{const{q:i,collections:a,limit:s=20,offset:o=0,include_total:r=!1}=e.query,{accountability:d}=e;if(!i||0===i.trim().length)return t.status(400).json({success:!1,error:"Search query (q) is required"});const m=i.trim();let _=Object.keys(l);if(a){const e=a.split(",").map(e=>e.trim());if(_=e.filter(e=>l[e]),0===_.length)return t.status(400).json({success:!1,error:`No valid collections specified. Available: ${Object.keys(l).join(", ")}`})}console.log(`Global search for: "${m}" in collections:`,_);const g=await n(),p={query:m,total_results:0,collections_searched:_,results_by_collection:{},all_results:[]},f=_.map(e=>async function(e,t,i,a,s,o){try{const r=l[e],n=new c(e,{schema:s,accountability:o}),d={_and:[{_or:r.searchFields.map(e=>({[e]:{_icontains:t}}))},{status:{_eq:"published"}}]},m=(await n.readByQuery({filter:d,limit:i,offset:a,fields:r.fields,sort:["-date_created"]})).map(e=>({id:e.id,title:u(e,r.displayFields.title),type:r.displayFields.type,image:u(e,r.displayFields.image),summary:u(e,r.displayFields.summary),slug:u(e,r.displayFields.slug),date_created:e.date_created})),_=await n.readByQuery({filter:d,aggregate:{count:["*"]},limit:1});return{items:m,total:_[0]?.count||0,limit:i,offset:a}}catch(t){throw console.error(`Error searching ${e}:`,t),t}}(e,m,parseInt(s),parseInt(o),g,d));if((await Promise.allSettled(f)).forEach((e,t)=>{const i=_[t];"fulfilled"===e.status?(p.total_results+=e.value.items.length,e.value.items.forEach(e=>{p.all_results.push({...e,collection:i,collection_weight:l[i].weight})})):(console.error(`Error searching ${i}:`,e.reason),p.results_by_collection[i]={items:[],total:0,error:e.reason.message})}),p.all_results.sort((e,t)=>e.collection_weight!==t.collection_weight?t.collection_weight-e.collection_weight:void 0!==e._score&&void 0!==t._score?t._score-e._score:0),"true"===r){const e=await async function(e,t,i,a){const s={},o=e.map(async e=>{try{const o=l[e],r=new c(e,{schema:i,accountability:a}),n={_and:[{_or:o.searchFields.map(e=>({[e]:{_icontains:t}}))},{status:{_eq:"published"}}]},d=await r.readByQuery({filter:n,aggregate:{count:["*"]},limit:1});s[e]=d[0]?.count||0}catch(t){console.error(`Error getting count for ${e}:`,t),s[e]=0}});return await Promise.allSettled(o),s}(_,m,g,d);p.total_counts=e}return t.json({success:!0,total:p.total_counts,limit:parseInt(s),offset:parseInt(o),data:p.all_results})}catch(e){return console.error("Global search error:",e),t.status(500).json({success:!1,error:"Failed to perform search",details:e.message})}}),e.post("/advanced",async(e,t)=>{try{const{query:i,collections:a=Object.keys(l),filters:s={},limit:o=20,offset:r=0,sort:m="relevance"}=e.body,{accountability:_}=e;if(!i||0===i.trim().length)return t.status(400).json({success:!1,error:"Search query is required"});const g=i.trim(),p=a.filter(e=>l[e]);if(0===p.length)return t.status(400).json({success:!1,error:`No valid collections specified. Available: ${Object.keys(l).join(", ")}`});const f=await n(),y={query:g,filters:s,total_results:0,collections_searched:p,results_by_collection:{},all_results:[]},h=p.map(e=>async function(e,t,i,a,s,o,r,n){try{const m=l[e],_=new c(e,{schema:r,accountability:n}),g=[{_or:m.searchFields.map(e=>({[e]:{_icontains:t}}))},{status:{_eq:"published"}}];i&&Object.keys(i).length>0&&Object.entries(i).forEach(([e,t])=>{t&&g.push({[e]:{_eq:t}})});const p={_and:g};let f=["-date_created"];"relevance"===o&&(f=["-date_created"]);const y=(await _.readByQuery({filter:p,limit:a,offset:s,fields:m.fields,sort:f})).map(e=>({id:e.id,title:u(e,m.displayFields.title),type:u(e,m.displayFields.type),image:u(e,m.displayFields.image),summary:u(e,m.displayFields.summary),slug:u(e,m.displayFields.slug),date_created:e.date_created,date_updated:e.date_updated,status:e.status,_highlight:d(e,t,m.searchFields)})),h=await _.readByQuery({filter:p,aggregate:{count:["*"]},limit:1});return{items:y,total:h[0]?.count||0,limit:a,offset:s}}catch(t){throw console.error(`Error searching ${e} with filters:`,t),t}}(e,g,s[e],parseInt(o),parseInt(r),m,f,_));return(await Promise.allSettled(h)).forEach((e,t)=>{const i=p[t];"fulfilled"===e.status?(y.results_by_collection[i]=e.value,y.total_results+=e.value.items.length,e.value.items.forEach(e=>{y.all_results.push({...e,collection:i,collection_weight:l[i].weight})})):(console.error(`Error searching ${i}:`,e.reason),y.results_by_collection[i]={items:[],total:0,error:e.reason.message})}),"relevance"===m?y.all_results.sort((e,t)=>e.collection_weight!==t.collection_weight?t.collection_weight-e.collection_weight:void 0!==e._score&&void 0!==t._score?t._score-e._score:0):"newest"===m?y.all_results.sort((e,t)=>new Date(t.date_created||t.date)-new Date(e.date_created||e.date)):"oldest"===m&&y.all_results.sort((e,t)=>new Date(e.date_created||e.date)-new Date(t.date_created||t.date)),t.json({success:!0,search:y})}catch(e){return console.error("Advanced search error:",e),t.status(500).json({success:!1,error:"Failed to perform advanced search",details:e.message})}})}},{name:"news",config:(e,{services:t,exceptions:i,getSchema:a})=>{const{ItemsService:s,AssetsService:o}=t;e.get("/public/recent",async(e,t,i)=>{try{const i=new s("main_news",{schema:e.schema,accountability:null}),a=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","title","slug","summary","content","comments_count","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:a,sort:["-date_created"],filter:{status:{_eq:"published"}}}),r=(o.data||o).map(e=>(e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,comments_count:e.comments_count,featured_image:e.featured_image}));t.json({data:r,meta:{total:r.length}})}catch(e){i(e)}}),e.get("/public/trending",async(e,t,i)=>{try{const i=new s("main_news",{schema:e.schema,accountability:null}),a=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","title","slug","summary","content","comments_count","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:a,sort:["-date_created"],filter:{status:{_eq:"published"},is_trending:{_eq:!0}}}),r=o.data||o,n=r.map(e=>(e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,comments_count:e.comments_count,featured_image:e.featured_image}));t.json({data:n,meta:{total:r.length}})}catch(e){console.log("trending error: ",e),i(e)}}),e.get("/public/free",async(e,t,i)=>{try{const i=new s("main_news",{schema:e.schema,accountability:null}),a=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","title","slug","summary","content","comments_count","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:a,sort:["-date_created"],filter:{status:{_eq:"published"},is_free_news:{_eq:!0}}}),r=o.data||o,n=r.map(e=>(e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,comments_count:e.comments_count,featured_image:e.featured_image}));t.json({data:n,meta:{total:r.length}})}catch(e){console.log("trending error: ",e),i(e)}})}},{name:"companies",config:(e,{services:t,exceptions:i})=>{const{ItemsService:a,AssetsService:s}=t;e.get("/",async(e,t,i)=>{try{const{accountability:i}=e,{limit:s=50,offset:o=0,sort:r="-date_created",filter:n={},search:c}=e.query,l=await getSchema(),d=new a("companies",{schema:l,accountability:e.accountability});let u={limit:parseInt(s),offset:parseInt(o),sort:Array.isArray(r)?r:[r],fields:["id","name","slug","description","logo.*","company_role","status","date_created","date_updated","favorites_count"]};n&&Object.keys(n).length>0&&(u.filter=n),c&&(u.search=c);const m=await d.readByQuery(u);if(i?.user){const r=await async function(e,t,i,s){if(0===e.length)return e;const o=new a("favourites",{schema:i,accountability:s}),r=e.map(e=>e.id),n=await o.readByQuery({filter:{_and:[{user_created:{_eq:t}},{collection:{_eq:"companies"}},{item_id:{_in:r}}]},fields:["id","item_id"],limit:-1}),c=new Map;return n.forEach(e=>{c.set(e.item_id,e.id)}),e.map(e=>({...e,is_favorited:c.has(e.id),favorite_id:c.get(e.id)||null}))}(m,i.user,l,e.accountability);return t.json({success:!0,companies:r,total:m.length,limit:parseInt(s),offset:parseInt(o),authenticated:!0})}const _=m.map(e=>({...e,is_favorited:!1,favorite_id:null}));return t.json({success:!0,companies:_,total:m.length,limit:parseInt(s),offset:parseInt(o),authenticated:!1})}catch(e){return console.error("Get companies with favorites error:",e),t.status(500).json({success:!1,error:"Failed to fetch companies",details:e.message})}}),e.get("/public/recent",async(e,t,i)=>{try{const i=new a("companies",{schema:e.schema,accountability:null}),s=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","name","slug","description","logo.id","logo.filename_disk","logo.title"],limit:s,sort:["-date_created"],filter:{status:{_eq:"published"}}}),r=(o.data||o).map(e=>(e.logo&&"object"==typeof e.logo&&e.logo.id&&(e.logo={id:e.logo.id,url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}?width=400&height=300&fit=cover`,title:e.logo.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,logo:e.logo}));t.json({data:r,meta:{total:r.length}})}catch(e){i(e)}}),e.get("/public/trending",async(e,t,i)=>{try{const i=new a("companies",{schema:e.schema,accountability:null}),s=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","name","slug","description","logo.id","logo.filename_disk","logo.title"],limit:s,sort:["-date_created"],filter:{status:{_eq:"published"},is_trending:{_eq:!0}}}),r=o.data||o,n=r.map(e=>(e.logo&&"object"==typeof e.logo&&e.logo.id&&(e.logo={id:e.logo.id,url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}?width=400&height=300&fit=cover`,title:e.logo.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,logo:e.logo}));t.json({data:n,meta:{total:r.length}})}catch(e){console.log("trending error: ",e),i(e)}}),e.get("/public/free",async(e,t,i)=>{try{const i=new a("companies",{schema:e.schema,accountability:null}),s=Math.min(parseInt(e.query.limit)||10,50),o=await i.readByQuery({fields:["id","name","slug","description","logo.id","logo.filename_disk","logo.title"],limit:s,sort:["-date_created"],filter:{status:{_eq:"published"},is_trending:{_eq:!0}}}),r=o.data||o,n=r.map(e=>(e.logo&&"object"==typeof e.logo&&e.logo.id&&(e.logo={id:e.logo.id,url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.logo.id}?width=400&height=300&fit=cover`,title:e.logo.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,logo:e.logo}));t.json({data:n,meta:{total:r.length}})}catch(e){console.log("trending error: ",e),i(e)}}),e.get("/:id",async(e,t,i)=>{try{const i=new a("companies",{schema:e.schema,accountability:e.accountability}),s=await i.readOne(e.params.id,{fields:["*","countries.countries_id.*","regions.regions_id.*","types.types_id.*","funding.funding_id.*","client_owner.companies_id.*","developer.companies_id.*","companies.companies_id.*","authority.companies_id.id","authority.companies_id.name","architect.companies_id.id","architect.companies_id.name","design_consultant.companies_id.id","design_consultant.companies_id.name","project_manager.companies_id.id","project_manager.companies_id.name","civil_engineer.companies_id.id","civil_engineer.companies_id.name","structural_engineer.companies_id.id","structural_engineer.companies_id.name","mep_engineer.companies_id.id","mep_engineer.companies_id.name","electrical_engineer.companies_id.id","electrical_engineer.companies_id.name","geotechnical_engineer.companies_id.id","geotechnical_engineer.companies_id.name","cost_consultants.companies_id.id","cost_consultants.companies_id.name","quantity_surveyor.companies_id.id","quantity_surveyor.companies_id.name","landscape_architect.companies_id.id","landscape_architect.companies_id.name","legal_adviser.companies_id.id","legal_adviser.companies_id.name","transaction_advisor.companies_id.id","transaction_advisor.companies_id.name","study_consultant.companies_id.id","study_consultant.companies_id.name","main_contractor.companies_id.id","main_contractor.companies_id.name","main_contract_bidder.companies_id.id","main_contract_bidder.companies_id.name","main_contract_prequalified.companies_id.id","main_contract_prequalified.companies_id.name","mep_subcontractor.companies_id.id","mep_subcontractor.companies_id.name","piling_subcontractor.companies_id.id","piling_subcontractor.companies_id.name","facade_subcontractor.companies_id.id","facade_subcontractor.companies_id.name","lift_subcontractor.companies_id.id","lift_subcontractor.companies_id.name","other_subcontractor.companies_id.id","other_subcontractor.companies_id.name","operator.companies_id.id","operator.companies_id.name","feed.companies_id.id","feed.companies_id.name","logo.*"]}),o=(e,t="id")=>e&&Array.isArray(e)?e.map(e=>{const i=e[`${t}_id`]||e;return i&&i.id?{id:i.id,name:i.name||"Unnamed"}:null}).filter(Boolean):[];s.logo&&"object"==typeof s.logo&&s.logo.id&&(s.logo.url=`${process.env.PUBLIC_URL}/assets/${s.logo.id}`,s.logo.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${s.logo.id}?width=400&height=300&fit=cover`),s.countries&&Array.isArray(s.countries)&&(s.countries=s.countries.map(e=>e.countries_id).filter(Boolean)),s.regions&&Array.isArray(s.regions)&&(s.regions=s.regions.map(e=>e.regions_id).filter(Boolean)),s.types&&Array.isArray(s.types)&&(s.types=s.types.map(e=>e.types_id).filter(Boolean)),s.funding&&Array.isArray(s.funding)&&(s.funding=s.funding.map(e=>e.funding_id).filter(Boolean)),s.companies&&Array.isArray(s.companies)&&(s.companies=s.companies.map(e=>e.companies_id).filter(Boolean)),s.client_owner&&Array.isArray(s.client_owner)&&(s.client_owner=s.client_owner.map(e=>e.companies_id).filter(Boolean)),s.developer&&Array.isArray(s.developer)&&(s.developer=s.developer.map(e=>e.companies_id).filter(Boolean)),s.developer=o(s.developer,"companies"),s.authority=o(s.authority,"companies"),s.architect=o(s.architect,"companies"),s.design_consultant=o(s.design_consultant,"companies"),s.project_manager=o(s.project_manager,"companies"),s.civil_engineer=o(s.civil_engineer,"companies"),s.structural_engineer=o(s.structural_engineer,"companies"),s.mep_engineer=o(s.mep_engineer,"companies"),s.electrical_engineer=o(s.electrical_engineer,"companies"),s.geotechnical_engineer=o(s.geotechnical_engineer,"companies"),s.cost_consultants=o(s.cost_consultants,"companies"),s.quantity_surveyor=o(s.quantity_surveyor,"companies"),s.landscape_architect=o(s.landscape_architect,"companies"),s.legal_adviser=o(s.legal_adviser,"companies"),s.transaction_advisor=o(s.transaction_advisor,"companies"),s.study_consultant=o(s.study_consultant,"companies"),s.funding=o(s.funding,"companies"),s.main_contractor=o(s.main_contractor,"companies"),s.main_contract_bidder=o(s.main_contract_bidder,"companies"),s.main_contract_prequalified=o(s.main_contract_prequalified,"companies"),s.mep_subcontractor=o(s.mep_subcontractor,"companies"),s.piling_subcontractor=o(s.piling_subcontractor,"companies"),s.facade_subcontractor=o(s.facade_subcontractor,"companies"),s.lift_subcontractor=o(s.lift_subcontractor,"companies"),s.other_subcontractor=o(s.other_subcontractor,"companies"),s.operator=o(s.operator,"companies"),s.feed=o(s.feed,"companies");let r=!1,n=null;const c=new a("favourites",{schema:schema,accountability:e.accountability}),l=await c.readByQuery({filter:{_and:[{user_created:{_eq:accountability.user}},{collection:{_eq:"companies"}},{item_id:{_eq:id}}]},limit:1});l.length>0&&(r=!0,n=l[0].id);const d={...s,is_favorited:r,favorite_id:n};t.json({data:d})}catch(e){i(e)}})}}],i=[];export{t as endpoints,e as hooks,i as operations};
