const e=[{name:"my-hook",config:({filter:e,action:t})=>{e("items.create",()=>{console.log("Creating Item!")}),t("items.create",()=>{console.log("Item created!")})}},{name:"recent-view-hook",config:({action:e},{services:t,database:i,getSchema:a})=>{const{ItemsService:s}=t;async function r(e,t,i){try{if(!i?.user)return;const r=await a(),o=new s("recent_views",{schema:r,accountability:i}),c=await o.readByQuery({filter:{_and:[{user_created:{_eq:i.user}},{collection:{_eq:e}},{item_id:{_eq:t}}]},limit:1}),n=(new Date).toISOString();c.length>0?(await o.updateOne(c[0].id,{date_updated:n}),console.log(`Updated recent view for ${e}:${t}`)):(await o.createOne({collection:e,item_id:t,date_updated:n}),console.log(`Created recent view for ${e}:${t}`),await async function(e,t,i=100){try{const a=await t.readByQuery({filter:{user_created:{_eq:e}},sort:["-date_updated"],limit:-1,fields:["id","date_updated"]});if(a.length>i){const s=a.slice(i),r=s.map(e=>e.id);await t.deleteMany(r),console.log(`Cleaned up ${s.length} old recent views for user ${e}`)}}catch(e){console.error("Error enforcing recent views limit:",e)}}(i.user,o))}catch(e){console.error("Error tracking recent view:",e)}}e("projects.items.read",async(e,{accountability:t})=>{await r("projects",e.key,t)}),e("companies.items.read",async(e,{accountability:t})=>{await r("companies",e.key,t)})}}],t=[{name:"projects",config:(e,{services:t,exceptions:i})=>{const{ItemsService:a,AssetsService:s}=t;e.get("/",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:e.accountability});if(!(await async function(e){if(!e?.user)return{regions:[],sectors:[],hasAccess:!1};const t=await database("directus_users").where("id",e.user).first("subscription_type","subscription_status","active_subscription");return t&&"active"===t.subscription_status&&"projects"===t.subscription_type?{regions:await database("user_subscription_regions").where("user_subscriptions_id",t.active_subscription).pluck("regions_id"),sectors:await database("user_subscription_sectors").where("user_subscriptions_id",t.active_subscription).pluck("types_id"),hasAccess:!0,subscriptionType:t.subscription_type}:{regions:[],sectors:[],hasAccess:!1}}(e.accountability)).hasAccess&&e.accountability?.user)return t.status(403).json({success:!1,error:"Projects subscription required",message:"You need an active Projects subscription to access this content"});const s=e.query.groupBy,r=parseInt(e.query.limit)||25,o=parseInt(e.query.page)||1,c=await i.readByQuery({fields:["id","title","slug","contract_value_usd","summary","description","estimated_project_value_usd","value_range","construction_start_date","location","current_stage","email","countries.countries_id.id","countries.countries_id.name","regions.regions_id.id","regions.regions_id.name","types.types_id.id","sectors.sectors_id.name","sectors.sectors_id.id","types.types_id.name","featured_image.id","featured_image.filename_disk","featured_image.title","featured_image.filesize"],limit:s?-1:r,page:s?1:o,filter:e.query.filter||{},meta:["total_count","filter_count"]}),n=c.data||c,l=c.meta||{},u=n.map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,e.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`);const t=e.countries?[...e.countries]:[],i=e.regions?[...e.regions]:[],a=e.types?[...e.types]:[],r=e.sectors?[...e.sectors]:[];return e.countries&&Array.isArray(e.countries)&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean)),e.regions&&Array.isArray(e.regions)&&(e.regions=e.regions.map(e=>e.regions_id).filter(Boolean)),e.types&&Array.isArray(e.types)&&(e.types=e.types.map(e=>e.types_id).filter(Boolean)),e.sectors&&Array.isArray(e.sectors)&&(e.sectors=e.sectors.map(e=>e.sectors_id).filter(Boolean)),s&&(e._originals={countries:t,regions:i,types:a,sectors:r}),e});if(s){const i=function(e,t){const i=new Map;return e.forEach(e=>{let a=[];switch(t){case"country":a=e._originals.countries.map(e=>({id:e.countries_id?.id,name:e.countries_id?.name||"Unknown Country",data:e.countries_id}));break;case"region":a=e._originals.regions.map(e=>({id:e.regions_id?.id,name:e.regions_id?.name||"Unknown Region",data:e.regions_id}));break;case"type":a=e._originals.types.map(e=>({id:e.types_id?.id,name:e.types_id?.name||"Unknown Type",data:e.types_id}));break;case"company":a=e._originals.companies.map(e=>({id:e.companies_id?.id,name:e.companies_id?.name||"Unknown Company",data:e.companies_id}));break;default:a=[{id:"all",name:"All Projects",data:null}]}0===a.length&&(a=[{id:"unknown",name:`Unknown ${t}`,data:null}]),a.forEach(t=>{i.has(t.id)||i.set(t.id,{id:t.id,name:t.name,data:t.data,projects:[],count:0,totalValue:0});const a=i.get(t.id),s={...e};delete s._originals,a.projects.push(s),a.count++,e.contract_value_usd&&(a.totalValue+=parseFloat(e.contract_value_usd)||0)})}),Array.from(i.values()).sort((e,t)=>e.name.localeCompare(t.name))}(u,s),a=parseInt(e.query.limit)||5,r=parseInt(e.query.page)||1,o=i.length,c=(r-1)*a,n=c+a,l=i.slice(c,n);t.json({data:l,meta:{total_groups:o,groupBy:s,page:r,limit:a,page_count:Math.ceil(o/a)}})}else t.json({data:u,meta:{total_count:l.total_count||l.filter_count||u.length,filter_count:l.filter_count||u.length,page:o,limit:r,page_count:Math.ceil((l.filter_count||u.length)/r)}})}catch(e){i(e)}}),e.get("/public/recent",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:null}),s=Math.min(parseInt(e.query.limit)||10,50),r=await i.readByQuery({fields:["id","title","slug","summary","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:s,sort:["-date_created"],filter:{status:{_eq:"published"}}}),o=(r.data||r).map(e=>(e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,featured_image:e.featured_image}));t.json({data:o,meta:{total:o.length}})}catch(e){i(e)}}),e.get("/public/trending",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:null}),s=Math.min(parseInt(e.query.limit)||10,50),r=await i.readByQuery({fields:["id","title","slug","summary","featured_image.id","featured_image.filename_disk","featured_image.title"],limit:s,sort:["-date_created"],filter:{status:{_eq:"published"},is_trending:{_eq:!0}}}),o=(r.data||r).map(e=>(e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image={id:e.featured_image.id,url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`,title:e.featured_image.title}),{id:e.id,title:e.title,slug:e.slug,summary:e.summary,featured_image:e.featured_image}));t.json({data:o,meta:{total:o.length}})}catch(e){i(e)}}),e.get("/:id",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:e.accountability}),s=await i.readOne(e.params.id,{fields:["*","countries.countries_id.*","regions.regions_id.*","types.types_id.*","funding.funding_id.*","client_owner.companies_id.*","developer.companies_id.*","companies.companies_id.*","authority.companies_id.id","authority.companies_id.name","architect.companies_id.id","architect.companies_id.name","design_consultant.companies_id.id","design_consultant.companies_id.name","project_manager.companies_id.id","project_manager.companies_id.name","civil_engineer.companies_id.id","civil_engineer.companies_id.name","structural_engineer.companies_id.id","structural_engineer.companies_id.name","mep_engineer.companies_id.id","mep_engineer.companies_id.name","electrical_engineer.companies_id.id","electrical_engineer.companies_id.name","geotechnical_engineer.companies_id.id","geotechnical_engineer.companies_id.name","cost_consultants.companies_id.id","cost_consultants.companies_id.name","quantity_surveyor.companies_id.id","quantity_surveyor.companies_id.name","landscape_architect.companies_id.id","landscape_architect.companies_id.name","legal_adviser.companies_id.id","legal_adviser.companies_id.name","transaction_advisor.companies_id.id","transaction_advisor.companies_id.name","study_consultant.companies_id.id","study_consultant.companies_id.name","main_contractor.companies_id.id","main_contractor.companies_id.name","main_contract_bidder.companies_id.id","main_contract_bidder.companies_id.name","main_contract_prequalified.companies_id.id","main_contract_prequalified.companies_id.name","mep_subcontractor.companies_id.id","mep_subcontractor.companies_id.name","piling_subcontractor.companies_id.id","piling_subcontractor.companies_id.name","facade_subcontractor.companies_id.id","facade_subcontractor.companies_id.name","lift_subcontractor.companies_id.id","lift_subcontractor.companies_id.name","other_subcontractor.companies_id.id","other_subcontractor.companies_id.name","operator.companies_id.id","operator.companies_id.name","feed.companies_id.id","feed.companies_id.name","featured_image.*"]}),r=(e,t="id")=>e&&Array.isArray(e)?e.map(e=>{const i=e[`${t}_id`]||e;return i&&i.id?{id:i.id,name:i.name||"Unnamed"}:null}).filter(Boolean):[];s.featured_image&&"object"==typeof s.featured_image&&s.featured_image.id&&(s.featured_image.url=`${process.env.PUBLIC_URL}/assets/${s.featured_image.id}`,s.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${s.featured_image.id}?width=400&height=300&fit=cover`),s.countries&&Array.isArray(s.countries)&&(s.countries=s.countries.map(e=>e.countries_id).filter(Boolean)),s.regions&&Array.isArray(s.regions)&&(s.regions=s.regions.map(e=>e.regions_id).filter(Boolean)),s.types&&Array.isArray(s.types)&&(s.types=s.types.map(e=>e.types_id).filter(Boolean)),s.funding&&Array.isArray(s.funding)&&(s.funding=s.funding.map(e=>e.funding_id).filter(Boolean)),s.companies&&Array.isArray(s.companies)&&(s.companies=s.companies.map(e=>e.companies_id).filter(Boolean)),s.client_owner&&Array.isArray(s.client_owner)&&(s.client_owner=s.client_owner.map(e=>e.companies_id).filter(Boolean)),s.developer&&Array.isArray(s.developer)&&(s.developer=s.developer.map(e=>e.companies_id).filter(Boolean)),s.developer=r(s.developer,"companies"),s.authority=r(s.authority,"companies"),s.architect=r(s.architect,"companies"),s.design_consultant=r(s.design_consultant,"companies"),s.project_manager=r(s.project_manager,"companies"),s.civil_engineer=r(s.civil_engineer,"companies"),s.structural_engineer=r(s.structural_engineer,"companies"),s.mep_engineer=r(s.mep_engineer,"companies"),s.electrical_engineer=r(s.electrical_engineer,"companies"),s.geotechnical_engineer=r(s.geotechnical_engineer,"companies"),s.cost_consultants=r(s.cost_consultants,"companies"),s.quantity_surveyor=r(s.quantity_surveyor,"companies"),s.landscape_architect=r(s.landscape_architect,"companies"),s.legal_adviser=r(s.legal_adviser,"companies"),s.transaction_advisor=r(s.transaction_advisor,"companies"),s.study_consultant=r(s.study_consultant,"companies"),s.funding=r(s.funding,"companies"),s.main_contractor=r(s.main_contractor,"companies"),s.main_contract_bidder=r(s.main_contract_bidder,"companies"),s.main_contract_prequalified=r(s.main_contract_prequalified,"companies"),s.mep_subcontractor=r(s.mep_subcontractor,"companies"),s.piling_subcontractor=r(s.piling_subcontractor,"companies"),s.facade_subcontractor=r(s.facade_subcontractor,"companies"),s.lift_subcontractor=r(s.lift_subcontractor,"companies"),s.other_subcontractor=r(s.other_subcontractor,"companies"),s.operator=r(s.operator,"companies"),s.feed=r(s.feed,"companies"),t.json({data:s})}catch(e){i(e)}})}},{name:"favourites",config:(e,t)=>{const{services:i,exceptions:a,database:s,env:r,logger:o,getSchema:c}=t,{ItemsService:n}=i,l=["projects","companies","main_news","project_tenders"];e.post("/toggle",async(e,t)=>{try{const{collection:i,item_id:a}=e.body,{accountability:r}=e;if(console.log("Toggle request:",{collection:i,item_id:a,user:r?.user}),!r?.user)return t.status(403).json({success:!1,error:"You must be authenticated to manage favorites"});if(!i||!a)return t.status(400).json({success:!1,error:"Collection and item_id are required"});if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const o=await c(),u=new n("favourites",{schema:o,accountability:e.accountability});console.log(`Proceeding without item existence check for ${i}:${a}`);const d=await u.readByQuery({filter:{_and:[{user_created:{_eq:r.user}},{collection:{_eq:i}},{item_id:{_eq:a}}]},limit:1});if(d.length>0){await u.deleteOne(d[0].id);try{await s(i).where("id",a).decrement("favorites_count",1)}catch(e){console.warn(`Could not decrement favorites_count for ${i}:`,e.message)}return t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"})}{const e=await u.createOne({collection:i,item_id:a});try{await s(i).where("id",a).increment("favorites_count",1)}catch(e){console.warn(`Could not increment favorites_count for ${i}:`,e.message)}return t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(i){return console.error("Toggle favorite error:",i),i.message.includes("foreign key")||i.message.includes("constraint")?t.status(404).json({success:!1,error:`Item not found in ${e.body.collection}`}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:i.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:i}=e.body,{accountability:a}=e;if(!a?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!i||!Array.isArray(i)||0===i.length)return t.status(400).json({success:!1,error:"Items array is required"});if(i.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});for(const e of i){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!l.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const s=new n("favorites",{schema:await c(),accountability:e.accountability}),r=i.map(e=>({_and:[{user_created:{_eq:a.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),o=await s.readByQuery({filter:{_or:r},limit:-1}),u={};return i.forEach(e=>{const t=`${e.collection}:${e.item_id}`,i=o.find(t=>t.collection===e.collection&&t.item_id===e.item_id);u[t]={collection:e.collection,item_id:e.item_id,favorited:!!i,favorite_id:i?.id||null,date_created:i?.date_created||null}}),t.json({success:!0,authenticated:!0,total:i.length,favorited_count:o.length,results:u})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:i}=e.params,{limit:a=10,period:s="all"}=e.query;if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const r=new n(i,{schema:await c(),accountability:e.accountability});let o={};if("all"!==s){const e=new Date;let t;switch(s){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(o.date_created={_gte:t.toISOString()})}const u=(await r.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...o},sort:["-favorites_count","-date_created"],limit:parseInt(a)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:i,period:s,total:u.length,popular:u})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:i}=e;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const a=new n("favourites",{schema:await c(),accountability:e.accountability}),s=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),r=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),o=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"main_news"}},aggregate:{count:"*"}}),l=await a.readByQuery({filter:{user_created:{_eq:i.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(s[0]?.count||0)+(r[0]?.count||0)+(o[0]?.count||0),by_collection:{projects:s[0]?.count||0,companies:r[0]?.count||0,main_news:o[0]?.count||0},recent:l}})}catch(e){return console.error("Get stats error:",e),t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.get("/:collection/:item_id/check",async(e,t)=>{try{const{collection:i,item_id:a}=e.params,{accountability:s}=e;if(!s?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});if(!l.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});const r=new n("favourites",{schema:await c(),accountability:e.accountability}),o=await r.readByQuery({filter:{_and:[{user_created:{_eq:s.user}},{collection:{_eq:i}},{item_id:{_eq:a}}]},limit:1}),u=o.length>0;return t.json({favorited:u,favorite_id:u?o[0].id:null,date_created:u?o[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:i}=e,{collection:a}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const r=new n("favourites",{schema:await c(),accountability:e.accountability}),o={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});o.collection={_eq:a}}const u=await r.readByQuery({filter:o,limit:-1,fields:["id","collection","item_id"]});if(0===u.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const d=u.map(e=>e.id);await r.deleteMany(d);const _={};u.forEach(e=>{_[e.collection]||(_[e.collection]={}),_[e.collection][e.item_id]||(_[e.collection][e.item_id]=0),_[e.collection][e.item_id]++});for(const[e,t]of Object.entries(_))for(const[i,a]of Object.entries(t))try{await s(e).where("id",i).decrement("favorites_count",a)}catch(t){console.warn(`Could not decrement favorites_count for ${e}:`,t.message)}return t.json({success:!0,message:`Deleted ${u.length} favorite(s)`,deleted:u.length,collection:a||"all"})}catch(e){return console.error("Clear favorites error:",e),t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}}),e.get("/",async(e,t)=>{try{const{accountability:i}=e,{collection:a,limit:s=50,offset:r=0,sort:o="-date_created"}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"You must be authenticated to view favorites"});const u=await c(),d=new n("favourites",{schema:u,accountability:e.accountability}),_={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${l.join(", ")}`});_.collection={_eq:a}}console.log("Fetching favorites with filter:",JSON.stringify(_));const m=await d.readByQuery({filter:_,sort:[o],limit:parseInt(s),offset:parseInt(r)});if(console.log("Favorites result:",m),!Array.isArray(m))return console.error("Favorites is not an array:",typeof m,m),t.status(500).json({success:!1,error:"Invalid response format from favorites service"});let p=0;try{const e=await d.readByQuery({filter:_,aggregate:{count:["*"]}});Array.isArray(e)&&e.length>0?p=e[0]?.count||0:e&&"object"==typeof e&&(p=e.count||0),console.log("Total count result:",e)}catch(e){console.warn("Could not get total count:",e.message)}const g={projects:[],companies:[],main_news:[]},f={projects:0,companies:0,main_news:0};if(m.length>0)for(const t of m)if(t.collection&&g[t.collection])try{const i=new n(t.collection,{schema:u,accountability:e.accountability});let a=["id","status","date_created","date_updated"];try{const e=u.collections[t.collection];e&&e.fields&&e.fields.favorites_count&&a.push("favorites_count")}catch(e){console.warn(`Could not check schema for ${t.collection}:`,e.message)}"projects"===t.collection?a.push("title","slug","summary","featured_image","contract_value_usd","current_stage"):"companies"===t.collection?a.push("name","slug","company_role","logo","description"):"main_news"===t.collection&&a.push("title","slug","summary","featured_image"),console.log(`Fetching ${t.collection} item ${t.item_id} with fields:`,a);const s=await i.readOne(t.item_id,{fields:a});s?(g[t.collection].push({favorite_id:t.id,favorite_date:t.date_created,...s}),f[t.collection]++):console.warn(`Item not found: ${t.collection} - ${t.item_id}`)}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message)}else console.warn("Invalid favorite item or collection:",t);return t.json({success:!0,total:p,limit:parseInt(s),offset:parseInt(r),counts:f,favorites:g})}catch(e){return console.error("Get favorites error:",e),t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}})}},{name:"recent-views",config:(e,t)=>{const{services:i,exceptions:a,database:s,env:r,logger:o,getSchema:c}=t,{ItemsService:n}=i,l=["projects","companies"];e.get("/",async(e,t)=>{try{const{accountability:i}=e,{collection:a,limit:s=20,offset:r=0}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"You must be authenticated to view recent history"});const o=await c(),u=new n("recent_views",{schema:o,accountability:e.accountability}),d={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${l.join(", ")}`});d.collection={_eq:a}}const _=await u.readByQuery({filter:d,sort:["-date_updated","-date_created"],limit:parseInt(s),offset:parseInt(r)}),m=await u.readByQuery({filter:d,aggregate:{count:["*"]}}),p={projects:[],companies:[]},g={projects:0,companies:0};for(const t of _)if(p[t.collection])try{const i=new n(t.collection,{schema:o,accountability:e.accountability});let a=["id","status","date_created","date_updated"];"projects"===t.collection?a.push("title","slug","summary","featured_image","contract_value_usd","current_stage"):"companies"===t.collection&&a.push("name","slug","company_role","logo","description");const s=await i.readOne(t.item_id,{fields:a});p[t.collection].push({view_id:t.id,view_date:t.date_created,last_viewed:t.date_updated,...s}),g[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message);try{await u.deleteOne(t.id)}catch(e){console.warn(`Could not delete orphaned recent view ${t.id}:`,e.message)}}return t.json({success:!0,total:m[0]?.count||0,limit:parseInt(s),offset:parseInt(r),counts:g,recent_views:p})}catch(e){return console.error("Get recent views error:",e),t.status(500).json({success:!1,error:"Failed to fetch recent views",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:i}=e,{collection:a}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const s=await c(),r=new n("recent_views",{schema:s,accountability:e.accountability}),o={user_created:{_eq:i.user}};if(a){if(!l.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${l.join(", ")}`});o.collection={_eq:a}}const u=await r.readByQuery({filter:o,limit:-1,fields:["id"]});if(0===u.length)return t.json({success:!0,message:"No recent views to delete",deleted:0});const d=u.map(e=>e.id);return await r.deleteMany(d),t.json({success:!0,message:`Deleted ${u.length} recent view(s)`,deleted:u.length,collection:a||"all"})}catch(e){return console.error("Clear recent views error:",e),t.status(500).json({success:!1,error:"Failed to clear recent views",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:i}=e,{period:a="week"}=e.query;if(!i?.user)return t.status(403).json({success:!1,error:"Authentication required"});const s=await c(),r=new n("recent_views",{schema:s,accountability:e.accountability}),o=new Date;let l;switch(a){case"day":l=new Date(o.setDate(o.getDate()-1));break;case"week":default:l=new Date(o.setDate(o.getDate()-7));break;case"month":l=new Date(o.setMonth(o.getMonth()-1))}const u=await r.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"projects"},date_created:{_gte:l.toISOString()}},aggregate:{count:["*"]}}),d=await r.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"companies"},date_created:{_gte:l.toISOString()}},aggregate:{count:["*"]}}),_=await r.readByQuery({filter:{user_created:{_eq:i.user},date_created:{_gte:l.toISOString()}},aggregate:{groupBy:["collection","item_id"],count:["*"]},sort:["-count"],limit:5});return t.json({success:!0,period:a,stats:{total:(u[0]?.count||0)+(d[0]?.count||0),by_collection:{projects:u[0]?.count||0,companies:d[0]?.count||0},start_date:l.toISOString(),frequent_items:_}})}catch(e){return console.error("Get recent views stats error:",e),t.status(500).json({success:!1,error:"Failed to fetch recent views statistics",details:e.message})}})}}],i=[];export{t as endpoints,e as hooks,i as operations};
