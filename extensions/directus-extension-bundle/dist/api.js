const e=[{name:"my-hook",config:({filter:e,action:t})=>{e("items.create",()=>{console.log("Creating Item!")}),t("items.create",()=>{console.log("Item created!")})}}],t=[{name:"projects",config:(e,{services:t,exceptions:a})=>{const{ItemsService:s,AssetsService:i}=t;e.get("/",async(e,t,a)=>{try{const a=new s("projects",{schema:e.schema,accountability:e.accountability}),i=e.query.groupBy,o=await a.readByQuery({fields:["*","countries.countries_id.*","regions.regions_id.*","types.types_id.*","featured_image.*"],limit:e.query.limit||-1,page:e.query.page||1,filter:e.query.filter||{}}),r=o.map(e=>{e.featured_image&&"object"==typeof e.featured_image&&e.featured_image.id&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,e.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`);const t=e.countries?[...e.countries]:[],a=e.regions?[...e.regions]:[],s=e.types?[...e.types]:[],i=e.funding?[...e.funding]:[],o=e.companies?[...e.companies]:[],r=e.client_owner?[...e.client_owner]:[],n=e.developer?[...e.developer]:[];return e.countries&&Array.isArray(e.countries)&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean)),e.regions&&Array.isArray(e.regions)&&(e.regions=e.regions.map(e=>e.regions_id).filter(Boolean)),e.types&&Array.isArray(e.types)&&(e.types=e.types.map(e=>e.types_id).filter(Boolean)),e.funding&&Array.isArray(e.funding)&&(e.funding=e.funding.map(e=>e.funding_id).filter(Boolean)),e.companies&&Array.isArray(e.companies)&&(e.companies=e.companies.map(e=>e.companies_id).filter(Boolean)),e.client_owner&&Array.isArray(e.client_owner)&&(e.client_owner=e.client_owner.map(e=>e.companies_id).filter(Boolean)),e.developer&&Array.isArray(e.developer)&&(e.developer=e.developer.map(e=>e.companies_id).filter(Boolean)),e._originals={countries:t,regions:a,types:s,funding:i,companies:o,client_owner:r,developer:n},e});if(i){const e=function(e,t){const a=new Map;return e.forEach(e=>{let s=[];switch(t){case"country":s=e._originals.countries.map(e=>({id:e.countries_id?.id,name:e.countries_id?.name||"Unknown Country",data:e.countries_id}));break;case"region":s=e._originals.regions.map(e=>({id:e.regions_id?.id,name:e.regions_id?.name||"Unknown Region",data:e.regions_id}));break;case"type":s=e._originals.types.map(e=>({id:e.types_id?.id,name:e.types_id?.name||"Unknown Type",data:e.types_id}));break;case"company":s=e._originals.companies.map(e=>({id:e.companies_id?.id,name:e.companies_id?.name||"Unknown Company",data:e.companies_id}));break;default:s=[{id:"all",name:"All Projects",data:null}]}0===s.length&&(s=[{id:"unknown",name:`Unknown ${t}`,data:null}]),s.forEach(t=>{a.has(t.id)||a.set(t.id,{id:t.id,name:t.name,data:t.data,projects:[],count:0,totalValue:0});const s=a.get(t.id),i={...e};delete i._originals,s.projects.push(i),s.count++,e.value&&(s.totalValue+=parseFloat(e.value)||0)})}),Array.from(a.values()).sort((e,t)=>e.name.localeCompare(t.name))}(r,i);t.json({data:e,meta:{total:r.length,groupBy:i,groups:e.length}})}else r.forEach(e=>delete e._originals),t.json({data:r,meta:{total:o.length,page:parseInt(e.query.page)||1,limit:parseInt(e.query.limit)||100}})}catch(e){a(e)}}),e.get("/:id",async(e,t,a)=>{try{const a=new s("projects",{schema:e.schema,accountability:e.accountability}),i=await a.readOne(e.params.id,{fields:["*","countries.countries_id.*","regions.regions_id.*","featured_image.*"]});i.featured_image&&"object"==typeof i.featured_image&&i.featured_image.id&&(i.featured_image.url=`${process.env.PUBLIC_URL}/assets/${i.featured_image.id}`,i.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${i.featured_image.id}?width=400&height=300&fit=cover`),i.countries&&Array.isArray(i.countries)&&(i.countries=i.countries.map(e=>e.countries_id).filter(Boolean)),i.regions&&Array.isArray(i.regions)&&(i.regions=i.regions.map(e=>e.regions_id).filter(Boolean)),i.types&&Array.isArray(i.types)&&(i.types=i.types.map(e=>e.types_id).filter(Boolean)),i.funding&&Array.isArray(i.funding)&&(i.funding=i.funding.map(e=>e.funding_id).filter(Boolean)),i.companies&&Array.isArray(i.companies)&&(i.companies=i.companies.map(e=>e.companies_id).filter(Boolean)),i.client_owner&&Array.isArray(i.client_owner)&&(i.client_owner=i.client_owner.map(e=>e.companies_id).filter(Boolean)),i.developer&&Array.isArray(i.developer)&&(i.developer=i.developer.map(e=>e.companies_id).filter(Boolean)),t.json({data:i})}catch(e){a(e)}})}},{name:"test",config:(e,{services:t,exceptions:a})=>{e.get("/",(e,t)=>{t.json({status:"ok",message:"Test endpoint works!"})})}},{name:"favorites",config:{id:"favorites",handler:(e,{services:t,exceptions:a,database:s})=>{const{ItemsService:i}=t,{ForbiddenException:o,InvalidPayloadException:r,ServiceUnavailableException:n}=a;e.post("/toggle",async(e,t)=>{try{const{collection:a,item_id:n}=e.body,{accountability:c}=e;if(!c?.user)throw new o("You must be authenticated to manage favorites");if(!a||!n)throw new r("Collection and item_id are required");const l=["projects","companies","news"];if(!l.includes(a))throw new r(`Invalid collection. Must be one of: ${l.join(", ")}`);const u=new i("favorites",{schema:e.schema,accountability:e.accountability}),d=new i(a,{schema:e.schema,accountability:e.accountability});try{await d.readOne(n)}catch(e){return t.status(404).json({success:!1,error:`Item not found in ${a}`})}const m=await u.readByQuery({filter:{_and:[{user_created:{_eq:c.user}},{collection:{_eq:a}},{item_id:{_eq:n}}]},limit:1});if(m.length>0)return await u.deleteOne(m[0].id),await s(a).where("id",n).decrement("favorites_count",1),t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"});{const e=await u.createOne({collection:a,item_id:n});return await s(a).where("id",n).increment("favorites_count",1),t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(e){return console.error("Toggle favorite error:",e),e instanceof o||e instanceof r?t.status(e.status||400).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:e.message})}}),e.get("/check/:collection/:item_id",async(e,t)=>{try{const{collection:a,item_id:s}=e.params,{accountability:o}=e;if(!o?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});const r=["projects","companies","news"];if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const n=new i("favorites",{schema:e.schema,accountability:e.accountability}),c=await n.readByQuery({filter:{_and:[{user_created:{_eq:o.user}},{collection:{_eq:a}},{item_id:{_eq:s}}]},limit:1}),l=c.length>0;return t.json({favorited:l,favorite_id:l?c[0].id:null,date_created:l?c[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.get("/my-favorites",async(e,t)=>{try{const{accountability:a}=e,{collection:s,limit:r=50,offset:n=0,sort:c="-date_created"}=e.query;if(!a?.user)throw new o("You must be authenticated to view favorites");const l=new i("favorites",{schema:e.schema,accountability:e.accountability}),u={user_created:{_eq:a.user}};if(s){const e=["projects","companies","news"];if(!e.includes(s))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${e.join(", ")}`});u.collection={_eq:s}}const d=await l.readByQuery({filter:u,sort:[c],limit:parseInt(r),offset:parseInt(n),fields:["*"]}),m=await l.readByQuery({filter:u,aggregate:{count:"*"}}),f={projects:[],companies:[],news:[]},p={projects:0,companies:0,news:0};for(const t of d)if(f[t.collection])try{const a=new i(t.collection,{schema:e.schema,accountability:e.accountability});let s=["id","status","date_created","date_updated","favorites_count"];"projects"===t.collection?s.push("title","slug","summary","featured_image","contract_value_usd","current_stage"):"companies"===t.collection?s.push("name","slug","company_type","logo","description"):"news"===t.collection&&s.push("title","slug","excerpt","featured_image","published_at");const o=await a.readOne(t.item_id,{fields:s});f[t.collection].push({favorite_id:t.id,favorite_date:t.date_created,favorite_notes:t.notes,favorite_tags:t.tags,...o}),p[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message)}return t.json({success:!0,total:m[0]?.count||0,limit:parseInt(r),offset:parseInt(n),counts:p,favorites:f})}catch(e){return console.error("Get favorites error:",e),e instanceof o?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:a}=e.params,{limit:s=10,period:o="all"}=e.query,r=["projects","companies","news"];if(!r.includes(a))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${r.join(", ")}`});const n=new i(a,{schema:e.schema,accountability:e.accountability});let c={};if("all"!==o){const e=new Date;let t;switch(o){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(c.date_created={_gte:t.toISOString()})}const l=(await n.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...c},sort:["-favorites_count","-date_created"],limit:parseInt(s)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:a,period:o,total:l.length,popular:l})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:a}=e.body,{accountability:s}=e;if(!s?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!a||!Array.isArray(a)||0===a.length)return t.status(400).json({success:!1,error:"Items array is required"});if(a.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});const o=["projects","companies","news"];for(const e of a){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!o.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const r=new i("favorites",{schema:e.schema,accountability:e.accountability}),n=a.map(e=>({_and:[{user_created:{_eq:s.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),c=await r.readByQuery({filter:{_or:n},limit:-1}),l={};return a.forEach(e=>{const t=`${e.collection}:${e.item_id}`,a=c.find(t=>t.collection===e.collection&&t.item_id===e.item_id);l[t]={collection:e.collection,item_id:e.item_id,favorited:!!a,favorite_id:a?.id||null,date_created:a?.date_created||null}}),t.json({success:!0,authenticated:!0,total:a.length,favorited_count:c.length,results:l})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:a}=e;if(!a?.user)throw new o("Authentication required");const s=new i("favorites",{schema:e.schema,accountability:e.accountability}),r=await s.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),n=await s.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),c=await s.readByQuery({filter:{user_created:{_eq:a.user},collection:{_eq:"news"}},aggregate:{count:"*"}}),l=await s.readByQuery({filter:{user_created:{_eq:a.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(r[0]?.count||0)+(n[0]?.count||0)+(c[0]?.count||0),by_collection:{projects:r[0]?.count||0,companies:n[0]?.count||0,news:c[0]?.count||0},recent:l}})}catch(e){return console.error("Get stats error:",e),e instanceof o?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:a}=e,{collection:r}=e.query;if(!a?.user)throw new o("Authentication required");const n=new i("favorites",{schema:e.schema,accountability:e.accountability}),c={user_created:{_eq:a.user}};if(r){const e=["projects","companies","news"];if(!e.includes(r))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${e.join(", ")}`});c.collection={_eq:r}}const l=await n.readByQuery({filter:c,limit:-1,fields:["id","collection","item_id"]});if(0===l.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const u=l.map(e=>e.id);await n.deleteMany(u);const d={};l.forEach(e=>{d[e.collection]||(d[e.collection]={}),d[e.collection][e.item_id]||(d[e.collection][e.item_id]=0),d[e.collection][e.item_id]++});for(const[e,t]of Object.entries(d))for(const[a,i]of Object.entries(t))await s(e).where("id",a).decrement("favorites_count",i);return t.json({success:!0,message:`Deleted ${l.length} favorite(s)`,deleted:l.length,collection:r||"all"})}catch(e){return console.error("Clear favorites error:",e),e instanceof o?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}})}}}],a=[];export{t as endpoints,e as hooks,a as operations};
