const e=[{name:"my-hook",config:({filter:e,action:t})=>{e("items.create",()=>{console.log("Creating Item!")}),t("items.create",()=>{console.log("Item created!")})}}],t=[{name:"projects",config:(e,{services:t,exceptions:i})=>{const{ItemsService:a,AssetsService:s}=t;e.get("/",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:e.accountability}),s=parseInt(e.query.page)||1,n=parseInt(e.query.limit)||25,o=(s-1)*n,c=[...["id","title","slug","contract_value_usd","summary","estimated_project_value_usd","value_range","construction_start_date","location","current_stage","status","date_created","date_updated","featured_image.id","featured_image.filename_disk","featured_image.title","featured_image.description"],...["countries.countries_id.id","countries.countries_id.name","regions.regions_id.id","regions.regions_id.name","types.types_id.id","types.types_id.name"]],r={...e.query.filter};e.accountability?.admin||r.status||(r.status={_eq:"published"});const[d,l]=await Promise.all([i.readByQuery({fields:c,limit:n,offset:o,sort:e.query.sort||"-date_created",filter:r,search:e.query.search}),i.readByQuery({filter:r,aggregate:{count:["*"]}})]),u=d.map(e=>(e.featured_image&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`,e.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}?width=400&height=300&fit=cover`),e.countries&&Array.isArray(e.countries)&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean).map(({id:e,name:t})=>({id:e,name:t}))),e.regions&&Array.isArray(e.regions)&&(e.regions=e.regions.map(e=>e.regions_id).filter(Boolean).map(({id:e,name:t})=>({id:e,name:t}))),e.types&&Array.isArray(e.types)&&(e.types=e.types.map(e=>e.types_id).filter(Boolean).map(({id:e,name:t})=>({id:e,name:t}))),e)),_=l[0]?.count||0,m=Math.ceil(_/n);t.json({data:u,meta:{total:_,page:s,limit:n,total_pages:m,has_next_page:s<m,has_prev_page:s>1}})}catch(e){i(e)}}),e.get("/:id",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:e.accountability});let s;try{s=await i.readOne(e.params.id,{fields:["id","status"]})}catch(e){return t.status(404).json({error:"Project not found",message:"The requested project does not exist or you do not have access to it."})}if(!e.accountability?.admin&&"published"!==s.status)return t.status(404).json({error:"Project not found",message:"The requested project is not available."});const n=["*","countries.countries_id.id","countries.countries_id.name","regions.regions_id.id","regions.regions_id.name","types.types_id.id","types.types_id.name","client_owner.companies_id.id","client_owner.companies_id.name","developer.companies_id.id","developer.companies_id.name","authority.companies_id.id","authority.companies_id.name","architect.companies_id.id","architect.companies_id.name","design_consultant.companies_id.id","design_consultant.companies_id.name","project_manager.companies_id.id","project_manager.companies_id.name","civil_engineer.companies_id.id","civil_engineer.companies_id.name","structural_engineer.companies_id.id","structural_engineer.companies_id.name","mep_engineer.companies_id.id","mep_engineer.companies_id.name","electrical_engineer.companies_id.id","electrical_engineer.companies_id.name","geotechnical_engineer.companies_id.id","geotechnical_engineer.companies_id.name","cost_consultants.companies_id.id","cost_consultants.companies_id.name","quantity_surveyor.companies_id.id","quantity_surveyor.companies_id.name","landscape_architect.companies_id.id","landscape_architect.companies_id.name","legal_adviser.companies_id.id","legal_adviser.companies_id.name","transaction_advisor.companies_id.id","transaction_advisor.companies_id.name","study_consultant.companies_id.id","study_consultant.companies_id.name","funding.companies_id.id","funding.companies_id.name","main_contractor.companies_id.id","main_contractor.companies_id.name","main_contract_bidder.companies_id.id","main_contract_bidder.companies_id.name","main_contract_prequalified.companies_id.id","main_contract_prequalified.companies_id.name","mep_subcontractor.companies_id.id","mep_subcontractor.companies_id.name","piling_subcontractor.companies_id.id","piling_subcontractor.companies_id.name","facade_subcontractor.companies_id.id","facade_subcontractor.companies_id.name","lift_subcontractor.companies_id.id","lift_subcontractor.companies_id.name","other_subcontractor.companies_id.id","other_subcontractor.companies_id.name","operator.companies_id.id","operator.companies_id.name","feed.companies_id.id","feed.companies_id.name","featured_image.*","gallery.directus_files_id.*"],o=await i.readOne(e.params.id,{fields:n});o.featured_image&&(o.featured_image.url=`${process.env.PUBLIC_URL}/assets/${o.featured_image.id}`,o.featured_image.thumbnail_url=`${process.env.PUBLIC_URL}/assets/${o.featured_image.id}?width=400&height=300&fit=cover`),o.gallery&&Array.isArray(o.gallery)&&(o.gallery=o.gallery.map(e=>{if(e.directus_files_id){const t=e.directus_files_id;return{id:t.id,title:t.title,description:t.description,url:`${process.env.PUBLIC_URL}/assets/${t.id}`,thumbnail_url:`${process.env.PUBLIC_URL}/assets/${t.id}?width=300&height=200&fit=cover`,sort:e.sort}}return e}).filter(Boolean));const c=(e,t="id")=>e&&Array.isArray(e)?e.map(e=>{const i=e[`${t}_id`]||e;return i&&i.id?{id:i.id,name:i.name||"Unnamed"}:null}).filter(Boolean):[];o.countries=c(o.countries,"countries"),o.regions=c(o.regions,"regions"),o.types=c(o.types,"types"),o.client_owner=c(o.client_owner,"companies"),o.developer=c(o.developer,"companies"),o.authority=c(o.authority,"companies"),o.architect=c(o.architect,"companies"),o.design_consultant=c(o.design_consultant,"companies"),o.project_manager=c(o.project_manager,"companies"),o.civil_engineer=c(o.civil_engineer,"companies"),o.structural_engineer=c(o.structural_engineer,"companies"),o.mep_engineer=c(o.mep_engineer,"companies"),o.electrical_engineer=c(o.electrical_engineer,"companies"),o.geotechnical_engineer=c(o.geotechnical_engineer,"companies"),o.cost_consultants=c(o.cost_consultants,"companies"),o.quantity_surveyor=c(o.quantity_surveyor,"companies"),o.landscape_architect=c(o.landscape_architect,"companies"),o.legal_adviser=c(o.legal_adviser,"companies"),o.transaction_advisor=c(o.transaction_advisor,"companies"),o.study_consultant=c(o.study_consultant,"companies"),o.funding=c(o.funding,"companies"),o.main_contractor=c(o.main_contractor,"companies"),o.main_contract_bidder=c(o.main_contract_bidder,"companies"),o.main_contract_prequalified=c(o.main_contract_prequalified,"companies"),o.mep_subcontractor=c(o.mep_subcontractor,"companies"),o.piling_subcontractor=c(o.piling_subcontractor,"companies"),o.facade_subcontractor=c(o.facade_subcontractor,"companies"),o.lift_subcontractor=c(o.lift_subcontractor,"companies"),o.other_subcontractor=c(o.other_subcontractor,"companies"),o.operator=c(o.operator,"companies"),o.feed=c(o.feed,"companies"),t.json({data:o})}catch(e){console.error("Error fetching project details:",e),i(e)}}),e.get("/search",async(e,t,i)=>{try{const i=new a("projects",{schema:e.schema,accountability:e.accountability}),{q:s,countries:n,regions:o,types:c,stage:r,min_value:d,max_value:l,page:u=1,limit:_=25,sort:m="-date_created"}=e.query,p=(u-1)*_,f={_and:[]};if(e.accountability?.admin||f._and.push({status:{_eq:"published"}}),s&&f._and.push({_or:[{title:{_icontains:s}},{summary:{_icontains:s}},{description:{_icontains:s}},{location:{_icontains:s}}]}),n){const e=Array.isArray(n)?n:[n];f._and.push({countries:{countries_id:{id:{_in:e}}}})}if(o){const e=Array.isArray(o)?o:[o];f._and.push({regions:{regions_id:{id:{_in:e}}}})}if(c){const e=Array.isArray(c)?c:[c];f._and.push({types:{types_id:{id:{_in:e}}}})}if(r&&f._and.push({current_stage:{_eq:r}}),d||l){const e={};d&&(e._gte=parseFloat(d)),l&&(e._lte=parseFloat(l)),f._and.push({contract_value_usd:e})}const g=["id","title","slug","contract_value_usd","summary","location","current_stage","status","date_created","featured_image.id","featured_image.filename_disk","countries.countries_id.id","countries.countries_id.name","types.types_id.id","types.types_id.name"],[y,h]=await Promise.all([i.readByQuery({fields:g,filter:f._and.length>0?f:{},limit:_,offset:p,sort:m}),i.readByQuery({filter:f._and.length>0?f:{},aggregate:{count:["*"]}})]),v=y.map(e=>(e.featured_image&&(e.featured_image.url=`${process.env.PUBLIC_URL}/assets/${e.featured_image.id}`),e.countries&&(e.countries=e.countries.map(e=>e.countries_id).filter(Boolean).map(({id:e,name:t})=>({id:e,name:t}))),e.types&&(e.types=e.types.map(e=>e.types_id).filter(Boolean).map(({id:e,name:t})=>({id:e,name:t}))),e)),b=h[0]?.count||0,w=Math.ceil(b/_);t.json({data:v,meta:{total:b,page:parseInt(u),limit:parseInt(_),total_pages:w,has_next_page:u<w,has_prev_page:u>1}})}catch(e){i(e)}})}},{name:"test",config:(e,{services:t,exceptions:i})=>{e.get("/",(e,t)=>{t.json({status:"ok",message:"Test endpoint works!"})})}},{name:"favorites",config:{id:"favorites",handler:(e,{services:t,exceptions:i,database:a})=>{const{ItemsService:s}=t,{ForbiddenException:n,InvalidPayloadException:o,ServiceUnavailableException:c}=i;e.post("/toggle",async(e,t)=>{try{const{collection:i,item_id:c}=e.body,{accountability:r}=e;if(!r?.user)throw new n("You must be authenticated to manage favorites");if(!i||!c)throw new o("Collection and item_id are required");const d=["projects","companies","news"];if(!d.includes(i))throw new o(`Invalid collection. Must be one of: ${d.join(", ")}`);const l=new s("favorites",{schema:e.schema,accountability:e.accountability}),u=new s(i,{schema:e.schema,accountability:e.accountability});try{await u.readOne(c)}catch(e){return t.status(404).json({success:!1,error:`Item not found in ${i}`})}const _=await l.readByQuery({filter:{_and:[{user_created:{_eq:r.user}},{collection:{_eq:i}},{item_id:{_eq:c}}]},limit:1});if(_.length>0)return await l.deleteOne(_[0].id),await a(i).where("id",c).decrement("favorites_count",1),t.json({success:!0,action:"removed",favorited:!1,message:"Removed from favorites"});{const e=await l.createOne({collection:i,item_id:c});return await a(i).where("id",c).increment("favorites_count",1),t.json({success:!0,action:"added",favorited:!0,favorite_id:e.id,message:"Added to favorites"})}}catch(e){return console.error("Toggle favorite error:",e),e instanceof n||e instanceof o?t.status(e.status||400).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to toggle favorite",details:e.message})}}),e.get("/check/:collection/:item_id",async(e,t)=>{try{const{collection:i,item_id:a}=e.params,{accountability:n}=e;if(!n?.user)return t.json({favorited:!1,favorite_id:null,authenticated:!1});const o=["projects","companies","news"];if(!o.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${o.join(", ")}`});const c=new s("favorites",{schema:e.schema,accountability:e.accountability}),r=await c.readByQuery({filter:{_and:[{user_created:{_eq:n.user}},{collection:{_eq:i}},{item_id:{_eq:a}}]},limit:1}),d=r.length>0;return t.json({favorited:d,favorite_id:d?r[0].id:null,date_created:d?r[0].date_created:null,authenticated:!0})}catch(e){return console.error("Check favorite error:",e),t.status(500).json({success:!1,error:"Failed to check favorite status",details:e.message})}}),e.get("/my-favorites",async(e,t)=>{try{const{accountability:i}=e,{collection:a,limit:o=50,offset:c=0,sort:r="-date_created"}=e.query;if(!i?.user)throw new n("You must be authenticated to view favorites");const d=new s("favorites",{schema:e.schema,accountability:e.accountability}),l={user_created:{_eq:i.user}};if(a){const e=["projects","companies","news"];if(!e.includes(a))return t.status(400).json({success:!1,error:`Invalid collection filter. Must be one of: ${e.join(", ")}`});l.collection={_eq:a}}const u=await d.readByQuery({filter:l,sort:[r],limit:parseInt(o),offset:parseInt(c),fields:["*"]}),_=await d.readByQuery({filter:l,aggregate:{count:"*"}}),m={projects:[],companies:[],news:[]},p={projects:0,companies:0,news:0};for(const t of u)if(m[t.collection])try{const i=new s(t.collection,{schema:e.schema,accountability:e.accountability});let a=["id","status","date_created","date_updated","favorites_count"];"projects"===t.collection?a.push("title","slug","summary","featured_image","contract_value_usd","current_stage"):"companies"===t.collection?a.push("name","slug","company_type","logo","description"):"news"===t.collection&&a.push("title","slug","excerpt","featured_image","published_at");const n=await i.readOne(t.item_id,{fields:a});m[t.collection].push({favorite_id:t.id,favorite_date:t.date_created,favorite_notes:t.notes,favorite_tags:t.tags,...n}),p[t.collection]++}catch(e){console.warn(`Could not fetch ${t.collection} item ${t.item_id}:`,e.message)}return t.json({success:!0,total:_[0]?.count||0,limit:parseInt(o),offset:parseInt(c),counts:p,favorites:m})}catch(e){return console.error("Get favorites error:",e),e instanceof n?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch favorites",details:e.message})}}),e.get("/popular/:collection",async(e,t)=>{try{const{collection:i}=e.params,{limit:a=10,period:n="all"}=e.query,o=["projects","companies","news"];if(!o.includes(i))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${o.join(", ")}`});const c=new s(i,{schema:e.schema,accountability:e.accountability});let r={};if("all"!==n){const e=new Date;let t;switch(n){case"day":t=new Date(e.setDate(e.getDate()-1));break;case"week":t=new Date(e.setDate(e.getDate()-7));break;case"month":t=new Date(e.setMonth(e.getMonth()-1));break;default:t=null}t&&(r.date_created={_gte:t.toISOString()})}const d=(await c.readByQuery({filter:{favorites_count:{_gt:0},status:{_eq:"published"},...r},sort:["-favorites_count","-date_created"],limit:parseInt(a)})).map((e,t)=>({rank:t+1,...e}));return t.json({success:!0,collection:i,period:n,total:d.length,popular:d})}catch(e){return console.error("Get popular items error:",e),t.status(500).json({success:!1,error:"Failed to fetch popular items",details:e.message})}}),e.post("/check-batch",async(e,t)=>{try{const{items:i}=e.body,{accountability:a}=e;if(!a?.user)return t.json({success:!0,authenticated:!1,results:{}});if(!i||!Array.isArray(i)||0===i.length)return t.status(400).json({success:!1,error:"Items array is required"});if(i.length>100)return t.status(400).json({success:!1,error:"Maximum 100 items per batch request"});const n=["projects","companies","news"];for(const e of i){if(!e.collection||!e.item_id)return t.status(400).json({success:!1,error:"Each item must have collection and item_id"});if(!n.includes(e.collection))return t.status(400).json({success:!1,error:`Invalid collection: ${e.collection}`})}const o=new s("favorites",{schema:e.schema,accountability:e.accountability}),c=i.map(e=>({_and:[{user_created:{_eq:a.user}},{collection:{_eq:e.collection}},{item_id:{_eq:e.item_id}}]})),r=await o.readByQuery({filter:{_or:c},limit:-1}),d={};return i.forEach(e=>{const t=`${e.collection}:${e.item_id}`,i=r.find(t=>t.collection===e.collection&&t.item_id===e.item_id);d[t]={collection:e.collection,item_id:e.item_id,favorited:!!i,favorite_id:i?.id||null,date_created:i?.date_created||null}}),t.json({success:!0,authenticated:!0,total:i.length,favorited_count:r.length,results:d})}catch(e){return console.error("Batch check error:",e),t.status(500).json({success:!1,error:"Failed to check favorites",details:e.message})}}),e.get("/stats",async(e,t)=>{try{const{accountability:i}=e;if(!i?.user)throw new n("Authentication required");const a=new s("favorites",{schema:e.schema,accountability:e.accountability}),o=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"projects"}},aggregate:{count:"*"}}),c=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"companies"}},aggregate:{count:"*"}}),r=await a.readByQuery({filter:{user_created:{_eq:i.user},collection:{_eq:"news"}},aggregate:{count:"*"}}),d=await a.readByQuery({filter:{user_created:{_eq:i.user}},sort:["-date_created"],limit:5});return t.json({success:!0,stats:{total:(o[0]?.count||0)+(c[0]?.count||0)+(r[0]?.count||0),by_collection:{projects:o[0]?.count||0,companies:c[0]?.count||0,news:r[0]?.count||0},recent:d}})}catch(e){return console.error("Get stats error:",e),e instanceof n?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to fetch statistics",details:e.message})}}),e.delete("/clear",async(e,t)=>{try{const{accountability:i}=e,{collection:o}=e.query;if(!i?.user)throw new n("Authentication required");const c=new s("favorites",{schema:e.schema,accountability:e.accountability}),r={user_created:{_eq:i.user}};if(o){const e=["projects","companies","news"];if(!e.includes(o))return t.status(400).json({success:!1,error:`Invalid collection. Must be one of: ${e.join(", ")}`});r.collection={_eq:o}}const d=await c.readByQuery({filter:r,limit:-1,fields:["id","collection","item_id"]});if(0===d.length)return t.json({success:!0,message:"No favorites to delete",deleted:0});const l=d.map(e=>e.id);await c.deleteMany(l);const u={};d.forEach(e=>{u[e.collection]||(u[e.collection]={}),u[e.collection][e.item_id]||(u[e.collection][e.item_id]=0),u[e.collection][e.item_id]++});for(const[e,t]of Object.entries(u))for(const[i,s]of Object.entries(t))await a(e).where("id",i).decrement("favorites_count",s);return t.json({success:!0,message:`Deleted ${d.length} favorite(s)`,deleted:d.length,collection:o||"all"})}catch(e){return console.error("Clear favorites error:",e),e instanceof n?t.status(403).json({success:!1,error:e.message}):t.status(500).json({success:!1,error:"Failed to clear favorites",details:e.message})}})}}}],i=[];export{t as endpoints,e as hooks,i as operations};
